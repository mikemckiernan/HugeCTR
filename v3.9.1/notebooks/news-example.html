<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NVIDIA Merlin on Microsoft’s News Dataset (MIND) &mdash; Merlin HugeCTR  documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/mystnb.css" type="text/css" />
      <link rel="stylesheet" href="../_static/togglebutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="canonical" href="https://nvidia-merlin.github.io/HugeCTR/main/notebooks/news-example.html" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script >let toggleHintShow = 'Click to show';</script>
        <script >let toggleHintHide = 'Click to hide';</script>
        <script >let toggleOpenOnPrint = 'true';</script>
        <script src="../_static/togglebutton.js"></script>
        <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Multi-GPU Offline Inference" href="multi_gpu_offline_inference.html" />
    <link rel="prev" title="HugeCTR Wide and Deep Model with Criteo" href="hugectr_wdl_prediction.html" /> 
</head>

<body class="wy-body-for-nav">
  <div class="banner">
    <p class="banner">
      Beginning in January 2023, versions for all NVIDIA Merlin projects
      will change from semantic versioning like <code>4.0</code>
      to calendar versioning like <code>23.01</code>.</p>
  </div>

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Merlin HugeCTR
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">HUGECTR</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hugectr_user_guide.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_core_features.html">Core Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_embedding_training_cache.html">Embedding Training Cache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hierarchical_parameter_server/index.html">Hierarchical Parameter Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance.html">Performance</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Example Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ecommerce-example.html">Merlin ETL, training, and inference with e-Commerce behavior data</a></li>
<li class="toctree-l2"><a class="reference internal" href="movie-lens-example.html">HugeCTR demo on Movie lens data</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr_criteo.html">Introduction to the HugeCTR Python Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr2onnx_demo.html">HugeCTR to ONNX Converter</a></li>
<li class="toctree-l2"><a class="reference internal" href="continuous_training.html">HugeCTR Continuous Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugectr_wdl_prediction.html">HugeCTR Wide and Deep Model with Criteo</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">NVIDIA Merlin on Microsoft’s News Dataset (MIND)</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_gpu_offline_inference.html">Multi-GPU Offline Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="hps_demo.html">Hierarchical Parameter Server Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="training_with_hdfs.html">HugeCTR training with HDFS example</a></li>
<li class="toctree-l2"><a class="reference internal" href="embedding_training_cache_example.html">Embedding Training Cache Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="embedding_collection.html">HugeCTR Embedding Collection</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="multi-modal-data/index.html">Multi-modal Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional_resources.html">Additional Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hugectr_contributor_guide.html">Contributing to HugeCTR</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Merlin HugeCTR</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">HugeCTR Example Notebooks</a></li>
      <li class="breadcrumb-item active">NVIDIA Merlin on Microsoft’s News Dataset (MIND)</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="tex2jax_ignore mathjax_ignore section" id="nvidia-merlin-on-microsoft-s-news-dataset-mind">
<h1>NVIDIA Merlin on Microsoft’s News Dataset (MIND)<a class="headerlink" href="#nvidia-merlin-on-microsoft-s-news-dataset-mind" title="Permalink to this headline"></a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h2>
<p>In this tutorial notebook, we would be using the <a class="reference external" href="https://msnews.github.io/">Microsoft’s News Dataset (MIND)</a> to demonstrate NVTabular for ETL the data and HugeCTR for training Deep Neural Network models for building a Recommender System.</p>
<p>The MIND dataset contains 15M impressions generated by 1M users over 160k news articles. Our goal from this jupyter notebook would be to train a model that can predict whether a user would click on a news article or not.</p>
<p>In order to build a Recommender System, we would be first cleaning and pre-processing the data, then developing simple time based and complex target &amp; count encoded features to finally train and evaluate Deep Learning Recommendation Model (DLRM).</p>
<p>Please remember to run this jupyter notebook in the <a class="reference external" href="https://ngc.nvidia.com/catalog/containers/nvidia:merlin:merlin-hugectr">merlin-hugectr:22.07</a> docker container.</p>
</div>
<div class="section" id="step-1-import-libraries-and-create-directories">
<h2>Step 1: Import libraries and create directories<a class="headerlink" href="#step-1-import-libraries-and-create-directories" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Install packages required for this notebook</span>
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>tqdm<span class="w"> </span>graphviz
<span class="o">!</span>apt<span class="w"> </span>install<span class="w"> </span>wget<span class="w"> </span>unzip<span class="w"> </span>graphviz<span class="w"> </span>-y
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">shutil</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">cupy</span> <span class="k">as</span> <span class="nn">cp</span>          <span class="c1"># CuPy is an implementation of NumPy-compatible multi-dimensional array on GPU</span>
<span class="kn">import</span> <span class="nn">cudf</span>                <span class="c1"># cuDF is an implementation of Pandas-like Dataframe on GPU</span>
<span class="kn">import</span> <span class="nn">rmm</span>                 <span class="c1"># library for pre-allocating memory on GPU</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># NVTabular is the core library we will use here for feature engineering/preprocessing on GPU</span>
<span class="kn">from</span> <span class="nn">nvtabular.ops</span> <span class="kn">import</span> <span class="n">Operator</span>
<span class="kn">import</span> <span class="nn">nvtabular</span> <span class="k">as</span> <span class="nn">nvt</span>
<span class="kn">from</span> <span class="nn">nvtabular.utils</span> <span class="kn">import</span> <span class="n">device_mem_size</span>

<span class="c1"># Dask is the backend job scheduler used by NVTabular</span>
<span class="kn">import</span> <span class="nn">dask</span>   
<span class="kn">import</span> <span class="nn">dask_cudf</span>
<span class="kn">from</span> <span class="nn">dask_cuda</span> <span class="kn">import</span> <span class="n">LocalCUDACluster</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">wait</span>
<span class="kn">from</span> <span class="nn">dask.utils</span> <span class="kn">import</span> <span class="n">parse_bytes</span>
<span class="kn">from</span> <span class="nn">dask.delayed</span> <span class="kn">import</span> <span class="n">delayed</span>
</pre></div>
</div>
</div>
</div>
<p>It is often a good idea to set-aside (fast) dedicated disk space for dask workers to spill data and logging information. To make things simple, we will perform all IO within a single <code class="docutils literal notranslate"><span class="pre">BASE_DIR</span></code> for this example. Feel free to set this variable yourself.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define &quot;fast&quot; root directory for this example</span>
<span class="n">BASE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;BASE_DIR&quot;</span><span class="p">,</span> <span class="s2">&quot;./basedir&quot;</span><span class="p">)</span>

<span class="c1"># Define worker/output directories</span>
<span class="n">dask_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;workdir&quot;</span><span class="p">)</span>

<span class="c1"># Directory to store the raw downloaded dataset</span>
<span class="n">data_input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;dataset&quot;</span><span class="p">)</span>
<span class="n">data_path_train</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">data_path_valid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">)</span>

<span class="c1"># Directory to store NVTabular&#39;s processed dataset</span>
<span class="n">data_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;processed_nvt&quot;</span><span class="p">)</span>
<span class="n">output_train_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">output_valid_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">)</span>

<span class="c1"># Directory to store HugeCTR&#39;s train configurations and weights</span>
<span class="n">config_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;configs&quot;</span><span class="p">)</span>
<span class="n">weights_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;weights&quot;</span><span class="p">)</span>

<span class="c1">#Creating and cleaning our worker/output directories</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Ensure BASE_DIR exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">)</span>

    <span class="c1"># Make sure we have a clean worker space for Dask</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dask_workdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dask_workdir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dask_workdir</span><span class="p">)</span>

    <span class="c1"># Make sure we have a clean path for downloading dataset and preprocessing</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">data_path_train</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">data_path_valid</span><span class="p">)</span>

    <span class="c1"># Make sure we have a clean output path</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_train_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_valid_path</span><span class="p">)</span>
    
    <span class="c1"># Make sure we have a clean configs and weights path</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">config_output_path</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">config_output_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">config_output_path</span><span class="p">)</span>    
        
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">weights_path</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">weights_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">weights_path</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Creation of the directories failed&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Successfully created the directories&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The following directory structure has been created and would be used to store everything concerning this tutorial:</p>
<p>basedir <br>
  |— workdir<br />
  |— dataset <br>
    |— train <br>
    |— valid  <br>
  |— processed_nvt <br>
     |— train <br>
     |— valid  <br>
  |— configs <br>
  |— weights <br></p>
</div>
<div class="section" id="step-2-deploy-a-distributed-dask-cluster">
<h2>Step 2: Deploy a Distributed-Dask cluster<a class="headerlink" href="#step-2-deploy-a-distributed-dask-cluster" title="Permalink to this headline"></a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the GPUs that are available to this notebook</span>
<span class="o">!</span>nvidia-smi
</pre></div>
</div>
</div>
</div>
<div class="section" id="initialize-dask-gpu-cluster">
<h3>Initialize Dask GPU Cluster<a class="headerlink" href="#initialize-dask-gpu-cluster" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">NUM_GPUS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># Set this to the GPU IDs that are observed from the above cell</span>

<span class="c1"># Dask dashboard</span>
<span class="n">dashboard_port</span> <span class="o">=</span> <span class="s2">&quot;8787&quot;</span>

<span class="c1"># Deploy a single-machine multi-GPU cluster</span>
<span class="n">protocol</span> <span class="o">=</span> <span class="s2">&quot;tcp&quot;</span>             <span class="c1"># &quot;tcp&quot; or &quot;ucx&quot;</span>
<span class="n">visible_devices</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">NUM_GPUS</span><span class="p">])</span>  <span class="c1"># Detect devices to place workers</span>
<span class="n">device_spill_frac</span> <span class="o">=</span> <span class="mf">0.9</span>      <span class="c1"># Spill GPU-Worker memory to host at this limit.</span>
                             <span class="c1"># Reduce if spilling fails to prevent</span>
                             <span class="c1"># device memory errors.</span>

<span class="c1"># Get device memory capacity</span>
<span class="n">capacity</span> <span class="o">=</span> <span class="n">device_mem_size</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;total&quot;</span><span class="p">)</span> 

<span class="c1"># Check if any device memory is already occupied</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">for dev in visible_devices.split(&quot;,&quot;):</span>
<span class="sd">    fmem = _pynvml_mem_size(kind=&quot;free&quot;, index=int(dev))</span>
<span class="sd">    used = (device_size - fmem) / 1e9</span>
<span class="sd">    if used &gt; 1.0:</span>
<span class="sd">        warnings.warn(f&quot;BEWARE - {used} GB is already occupied on device {int(dev)}!&quot;)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">cluster</span> <span class="o">=</span> <span class="kc">None</span>               <span class="c1"># (Optional) Specify existing scheduler port</span>
<span class="k">if</span> <span class="n">cluster</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCUDACluster</span><span class="p">(</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">,</span>
        <span class="n">n_workers</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">visible_devices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)),</span>
        <span class="n">CUDA_VISIBLE_DEVICES</span> <span class="o">=</span> <span class="n">visible_devices</span><span class="p">,</span>
        <span class="n">device_memory_limit</span> <span class="o">=</span> <span class="n">capacity</span> <span class="o">*</span> <span class="n">device_spill_frac</span><span class="p">,</span>
        <span class="n">local_directory</span><span class="o">=</span><span class="n">dask_workdir</span><span class="p">,</span>
        <span class="n">dashboard_address</span><span class="o">=</span><span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="n">dashboard_port</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Create the distributed client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
<span class="n">client</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize RMM pool on ALL workers</span>
<span class="k">def</span> <span class="nf">_rmm_pool</span><span class="p">():</span>
    <span class="n">rmm</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">(</span>
        <span class="n">pool_allocator</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">initial_pool_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># Use default size</span>
    <span class="p">)</span>
    
<span class="n">client</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">_rmm_pool</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="step-3-download-explore-mind-dataset">
<h2>Step 3:  Download &amp; explore MIND dataset<a class="headerlink" href="#step-3-download-explore-mind-dataset" title="Permalink to this headline"></a></h2>
<p>MIcrosoft News Dataset (MIND) is a large-scale dataset for news recommendation research. It was collected from anonymized behavior logs of Microsoft News website.</p>
<p>Please read and accept the Microsoft Research License Terms before downloading.</p>
<p>Let’s download the train and validation set, and unzip them to their respective directories.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>wget<span class="w"> </span>https://mind201910small.blob.core.windows.net/release/MINDlarge_train.zip
<span class="o">!</span>wget<span class="w"> </span>https://mind201910small.blob.core.windows.net/release/MINDlarge_dev.zip
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>unzip<span class="w"> </span>MINDlarge_train.zip<span class="w"> </span>-d<span class="w"> </span><span class="nv">$BASE_DIR</span>/dataset/train
<span class="o">!</span>unzip<span class="w"> </span>MINDlarge_dev.zip<span class="w"> </span>-d<span class="w">  </span><span class="nv">$BASE_DIR</span>/dataset/valid
</pre></div>
</div>
</div>
</div>
<p>The MIND dataset for news recommendation was collected from anonymized behavior logs of Microsoft News website. To protect user’s privacy, each user is de-linked from the production system when securely hashed into an anonymized ID.
MIND dataset team has randomly sampled 1M users who had at least 5 news clicks from October 12 to November 22, 2019 (6 weeks).</p>
<p>Microsoft has provided train, validation and test sets of this data but we are going to use the train and validation set for this tutorial.</p>
<div class="section" id="dataset-format">
<h3>Dataset format<a class="headerlink" href="#dataset-format" title="Permalink to this headline"></a></h3>
<p>Each set of this data contains the following 4 files:</p>
<ol class="arabic simple">
<li><p>behaviors.tsv - The click history and impression logs of users</p></li>
<li><p>news.tsv - Details of news articles mapped with the news ID</p></li>
<li><p>entity_embedding.vec - The embeddings of entities in news extracted from knowledge graph</p></li>
<li><p>relation_embedding.vec - The embeddings of relations between entities extracted from knowledge graph</p></li>
</ol>
<p>Let’s take a look at both these TSV files and understand how we can utilise them for our Recommendation System. <br>
Note - For the ease of this tutorial, we are ignoring the embeddings provided by the MIND team.</p>
</div>
<div class="section" id="behaviors-data">
<h3>Behaviors data<a class="headerlink" href="#behaviors-data" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">behaviors_train</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path_train</span> <span class="p">,</span> <span class="s1">&#39;behaviors.tsv&#39;</span><span class="p">),</span> 
                                <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,)</span>
<span class="n">behaviors_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Each row in this data file represents one instance of an impression generated by the user. The columns of behaviors data are represented as:<br></p>
<p>[Impression ID] [User ID] [Time until when Impression Recorded] [User Click History] [Impression News]</p>
<p><strong>Column 0</strong>: Impression ID (int64)<br>
This is the ID of the impression generated.<br>
e.g. 1,2,3,4,5</p>
<p><strong>Column 1</strong>: User ID (string)<br>
The anonymous ID of a user who has generated that impression.<br>
e.g. U89 , U395 , U60005, U3965770</p>
<p><strong>Column 2</strong>: Time (timestamp)<br>
The impression time with format <code class="docutils literal notranslate"><span class="pre">MM/DD/YYYY</span> <span class="pre">HH:MM:SS</span> <span class="pre">AM/PM</span></code> <br>
This is the point of time upto which the user’s impression have been captured.</p>
<p><strong>Column 3</strong>: History (string)<br>
The news click history of this user before this impression. The clicked news articles are ordered by time.<br>
e.g. N106403 N71977 N97080 N102132 N97212 N121652</p>
<p><strong>Column 4</strong>: Impressions (string)<br>
List of news displayed to the user and user’s click behaviors on them (1 for click and 0 for non-click).<br>
e.g. N129416-0 N26703-1 N120089-1 N53018-0 N89764-0 N91737-0 N29160-0</p>
<p>The corresponding details of news ID in history and impression columns would be present in the news.tsv file.</p>
<p>For more details on dataset: Official MIND Dataset Description, click <a class="reference external" href="https://github.com/msnews/msnews.github.io/blob/master/assets/doc/introduction.md">Official Dataset Description</a></p>
<p>Let’s reload the data with their respective column names.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">behaviors_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;impression_id&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span> <span class="s1">&#39;impressions&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">behaviors_train</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path_train</span> <span class="p">,</span> <span class="s1">&#39;behaviors.tsv&#39;</span><span class="p">),</span> 
                          <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                          <span class="n">names</span><span class="o">=</span><span class="n">behaviors_columns</span><span class="p">,</span>
                    <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,)</span>
<span class="n">behaviors_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">behaviors_valid</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path_valid</span> <span class="p">,</span> <span class="s1">&#39;behaviors.tsv&#39;</span><span class="p">),</span> 
                          <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                          <span class="n">names</span><span class="o">=</span><span class="n">behaviors_columns</span><span class="p">,</span>
                    <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,)</span>
<span class="n">behaviors_valid</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="news-data">
<h3>News data<a class="headerlink" href="#news-data" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">news_train</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path_train</span> <span class="p">,</span> <span class="s1">&#39;news.tsv&#39;</span><span class="p">),</span> 
                          <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                          <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,)</span>
<span class="n">news_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Each row in this data file represents a news article and its attributes. The columns of this data file are:</p>
<p>[News ID] [Category] [Subcategory] [News Title] [News Abstract] [News Url] [Entities in News Title] [Entities in News Abstract]</p>
<p><strong>Column 0</strong>: News ID (string)<br>
This is the ID of the news article<br>
e.g. N89 , N395 , N60005, N3965770</p>
<p><strong>Column 1</strong>: Category (string)<br>
Category of the news. There are 18 categories<br>
e.g. sports , health , news … etc</p>
<p><strong>Column 2</strong>: SubCategory (string)<br>
Sub-category of the news. There are 242 unique sub-categories.<br>
e.g. golf, newsscienceandtechnology, medical, newsworld … etc</p>
<p><strong>Column 3</strong>: Title (string)<br>
Title of the news article<br>
e.g. PGA Tour winners, 50 Worst Habits For Belly Fats … etc</p>
<p><strong>Column 4</strong>: Abstract (string)<br>
Abstract of the news article<br>
e.g. A gallery of recent winners on the PGA Tour, These seemingly harmless habits are holding</p>
<p><strong>Column 5</strong>: URL (string)<br>
URL to the MSN site where the news article was published.<br>
e.g. <a class="reference external" href="https://www.msn.com/en-us/sports/golf/pga-tour-winners/ss-AAjnQjj?ocid=chopendata">https://www.msn.com/en-us/sports/golf/pga-tour-winners/ss-AAjnQjj?ocid=chopendata</a></p>
<p><strong>Column 6</strong>: Title Entities (string)<br>
Entities present in the title</p>
<p><strong>Column 7</strong>: Abstract Entites (string)<br>
Entites present in the abstract</p>
<p>Let’s reload the data with their respective column names.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">news_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;did&#39;</span><span class="p">,</span> <span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;sub_cat&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title_entities&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract_entities&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">news_train</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path_train</span> <span class="p">,</span> <span class="s1">&#39;news.tsv&#39;</span><span class="p">),</span> 
                          <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                          <span class="n">names</span><span class="o">=</span><span class="n">news_columns</span><span class="p">,</span>
                    <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,)</span>
<span class="n">news_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">news_valid</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_path_valid</span> <span class="p">,</span> <span class="s1">&#39;news.tsv&#39;</span><span class="p">),</span> 
                          <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                          <span class="n">names</span><span class="o">=</span><span class="n">news_columns</span><span class="p">,</span>
                    <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,)</span>
<span class="n">news_valid</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="step-4-initial-pre-processing-to-prepare-dataset-for-feature-engineering">
<h2>Step 4 : Initial pre-processing to prepare dataset for feature engineering<a class="headerlink" href="#step-4-initial-pre-processing-to-prepare-dataset-for-feature-engineering" title="Permalink to this headline"></a></h2>
<p>Before we use the data in NVTabular for pre-processing and feature engineering, we have to make a few changes to make it efficient for GPU operations.<br>
The changes we have to make in the behaviours data file are:</p>
<ul class="simple">
<li><p>The history column is a long string and not a list. NVTabular support multi-hot categorical features but HugeCTR parquet reader does not,.Thus we need to extend the dataframe with multiple history columns, capturing each element in this long string. While extending the history columns, we have to make sure we pick the most recent history (in reverse chronological order).</p></li>
<li><p>The impression column contains a long string of unique negative and positive values for the same impression event. Each of these unique values in this column is a data point for our model to learn from. Thus, these unique positive &amp; negative entries should be unrolled into multiple rows. The row expansion operation is not supported in NVtabular and hence we’re going to perform it with cuDF.</p></li>
</ul>
<p>As for the news data file, we would just be using the news id, category and sub-category columns.<br>
Their are many ways to use the other columns (title, abstract, entities etc.) as features but we would leave it up to you to explore those.</p>
<p>In a nutshell, we are going to take the raw downloaded dataset, do these basic pre-processing using cuDF, generate a new train dataset which will then be used for further processing.</p>
<div class="section" id="pre-process-1-drop-columns-from-the-news-dataset">
<h3>Pre-process 1: Drop columns from the news dataset<a class="headerlink" href="#pre-process-1-drop-columns-from-the-news-dataset" title="Permalink to this headline"></a></h3>
<p>The columns that we would drop from the news.tsv are: ‘title’, ‘abstract’, ‘url’, ‘title_entities’, ‘abstract_entities’</p>
<p>We encourage you to explore using ‘title_entities’ and ‘abstract_entities’ as categorical features.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">news_train</span> <span class="o">=</span> <span class="n">news_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title_entities&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract_entities&#39;</span><span class="p">],</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">news_valid</span> <span class="o">=</span> <span class="n">news_valid</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;title_entities&#39;</span><span class="p">,</span> <span class="s1">&#39;abstract_entities&#39;</span><span class="p">],</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Merging news train/valid dataset to have a single view of news and their attributes</span>
<span class="n">news</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">news_train</span><span class="p">,</span><span class="n">news_valid</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;index&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Freeing up memory by nulling the variables</span>
<span class="n">news_train</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">news_valid</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">news</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pre-process-2-label-encoding-for-categorical-variables">
<h3>Pre-process 2:  Label encoding for categorical variables<a class="headerlink" href="#pre-process-2-label-encoding-for-categorical-variables" title="Permalink to this headline"></a></h3>
<p>Strings require significant amount of memory as compared to integers. As an example, representing the string <code class="docutils literal notranslate"><span class="pre">cfcd208495d565ef66e7dff9f98764</span></code> as integer <code class="docutils literal notranslate"><span class="pre">0</span></code> can save upto 90% memory.</p>
<p>Thus, we would be label encoding the categorical variables in our dataset so that the downstream pre-preprocessing and feature engineering pipelines doesn’t consume a high amount of memory.<br>
We will also label encode low cardinality columns in news.tsv like the news_categories and news_subcategories.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Encoding user id from both train and validation dataframe</span>
<span class="n">user_index</span> <span class="o">=</span> <span class="p">{}</span> 

<span class="n">temp</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">behaviors_train</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">],</span><span class="n">behaviors_valid</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span> 
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)),</span><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)):</span>
    <span class="n">user_index</span><span class="p">[</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Replacing uid in the dataset with their respective indexes</span>

<span class="n">behaviors_train</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">behaviors_train</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">user_index</span><span class="p">],[</span><span class="nb">str</span><span class="p">(</span><span class="n">user_index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">user_index</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
<span class="n">behaviors_valid</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">behaviors_valid</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">user_index</span><span class="p">],[</span><span class="nb">str</span><span class="p">(</span><span class="n">user_index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">user_index</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

<span class="c1"># Freeing up memory by nulling variables</span>
<span class="n">user_index</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Encoding news id from the combined news dataframe</span>
<span class="n">news_index</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">data</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">news</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">news</span><span class="p">)):</span>
    <span class="n">news_index</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;did&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Encoding new&#39;s category and subcategories</span>

<span class="n">cat</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">subcat</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">temp</span> <span class="o">=</span> <span class="n">news</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)),</span><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)):</span>
    <span class="n">cat</span><span class="p">[</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    
<span class="n">temp</span> <span class="o">=</span> <span class="n">news</span><span class="p">[</span><span class="s1">&#39;sub_cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)),</span><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)):</span>
    <span class="n">subcat</span><span class="p">[</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># Replacing did, cat and sub_cate with their respective indexes in the news dataframe</span>
<span class="n">news</span> <span class="o">=</span> <span class="n">news</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">&#39;did&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news_index</span><span class="p">],</span> <span class="s1">&#39;cat&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">],</span> <span class="s1">&#39;sub_cat&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subcat</span><span class="p">]},{</span><span class="s1">&#39;did&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">news_index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news_index</span><span class="p">],</span> <span class="s1">&#39;cat&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cat</span><span class="p">],</span> <span class="s1">&#39;sub_cat&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">subcat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subcat</span><span class="p">]})</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
<span class="n">news</span> <span class="o">=</span> <span class="n">news</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;did&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

<span class="c1"># Freeing up memory by nulling variables</span>
<span class="n">temp</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">cat</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">subcat</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p>We will replace the news id with their corresponding news_index in the behaviours dataframe in the pre-process step 3.</p>
</div>
<div class="section" id="pre-process-3-unroll-items-in-history-column">
<h3>Pre-process 3: Unroll items in history column<a class="headerlink" href="#pre-process-3-unroll-items-in-history-column" title="Permalink to this headline"></a></h3>
<p>As an example, consider the below row in behaviours dataframe</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-center head"><p>impression_id</p></th>
<th class="text-center head"><p>uid</p></th>
<th class="text-center head"><p>time</p></th>
<th class="text-center head"><p>history</p></th>
<th class="text-center head"><p>impressions</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>1</p></td>
<td class="text-center"><p>U64099</p></td>
<td class="text-center"><p>11/19/2019 11:37:45 AM</p></td>
<td class="text-center"><p>N121133 N104200 N43255 N55860 N128965 N38014</p></td>
<td class="text-center"><p>N78206-0 N26368-1 N7578-1 N58592-0 N19858-0</p></td>
</tr>
</tbody>
</table>
<p>We have to convert one history column with many news id to multiple history columns with single news id.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-center head"><p>hist_0</p></th>
<th class="text-center head"><p>hist_1</p></th>
<th class="text-center head"><p>hist_2</p></th>
<th class="text-center head"><p>hist_3</p></th>
<th class="text-center head"><p>hist_4</p></th>
<th class="text-center head"><p>hist_5</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>N121133</p></td>
<td class="text-center"><p>N104200</p></td>
<td class="text-center"><p>N43255</p></td>
<td class="text-center"><p>N55860</p></td>
<td class="text-center"><p>N128965</p></td>
<td class="text-center"><p>N38014</p></td>
</tr>
</tbody>
</table>
<p>Finally, we will add the news category and subcategory for these news ids. The row after these transformations would look like this:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-center head"><p>impression_id</p></th>
<th class="text-center head"><p>uid</p></th>
<th class="text-center head"><p>time</p></th>
<th class="text-center head"><p>hist_cat_0</p></th>
<th class="text-center head"><p>hist_cat_1</p></th>
<th class="text-center head"><p>hist_cat_2</p></th>
<th class="text-center head"><p>…</p></th>
<th class="text-center head"><p>hist_subcat_3</p></th>
<th class="text-center head"><p>hist_subcat_4</p></th>
<th class="text-center head"><p>hist_subcat_5</p></th>
<th class="text-center head"><p>impressions</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>1</p></td>
<td class="text-center"><p>U64099</p></td>
<td class="text-center"><p>11/19/2019 11:37:45 AM</p></td>
<td class="text-center"><p>sports</p></td>
<td class="text-center"><p>finance</p></td>
<td class="text-center"><p>entertainment</p></td>
<td class="text-center"><p>…</p></td>
<td class="text-center"><p>markets</p></td>
<td class="text-center"><p>celebrity</p></td>
<td class="text-center"><p>football_nfl</p></td>
<td class="text-center"><p>N78206-0 N26368-1 N7578-1 N58592-0 N19858-0</p></td>
</tr>
</tbody>
</table>
<p>We observed that the maximum number of items in the history column is 400 &amp; the mean is 30.<br>
We have to unroll the same number of history items for each row and thus would define a variable that will control this number. Feel free to increase this number to include more items.</p>
<p>For this tutorial, <code class="docutils literal notranslate"><span class="pre">max_hist</span></code> i.e. the number of history columns to be unrolled is set to 10.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_hist</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<p>Lets expand the history column into individual columns of histories with the limit <code class="docutils literal notranslate"><span class="pre">max_hist</span></code>.
During expansion, we will use the last <code class="docutils literal notranslate"><span class="pre">max_hist</span></code> items from history column as those items would be the most recent ones (since the news id in this column is ordered by time).</p>
<p>In addition, we’re also saving the length of history in a seperate column which could be used as a feature too.</p>
<p>We will also replace the news id with their news indexes in the behaviours dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Making a new gdf for storing history</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> 

<span class="c1"># Splitting the long string of history into several columns</span>
<span class="n">hist</span><span class="p">[[</span><span class="s1">&#39;hist_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hist</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">behaviors_train</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">max_hist</span><span class="p">,</span><span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">max_hist</span><span class="o">+</span><span class="mi">1</span><span class="p">)]]</span>

<span class="c1"># Replacing string news id in history with respective indexes</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news_index</span><span class="p">],[</span><span class="nb">str</span><span class="p">(</span><span class="n">news_index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news_index</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

<span class="c1"># Appending news category corresponding to these newly created history columns</span>
<span class="n">behaviors_train</span><span class="p">[[</span><span class="s1">&#39;hist_cat_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hist</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">],[</span><span class="nb">int</span><span class="p">(</span><span class="n">news</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cat&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">])</span>

<span class="c1"># Appending news sub-category corresponding to these newly created history columns</span>
<span class="n">behaviors_train</span><span class="p">[[</span><span class="s1">&#39;hist_subcat_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hist</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">],[</span><span class="nb">int</span><span class="p">(</span><span class="n">news</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;sub_cat&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">])</span>

<span class="c1"># Creating a column for the length of history </span>
<span class="n">behaviors_train</span><span class="p">[</span><span class="s1">&#39;hist_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">behaviors_train</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

<span class="c1"># Dropping the long string history column</span>
<span class="n">behaviors_train</span> <span class="o">=</span> <span class="n">behaviors_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;history&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Freeing up memory by nulling variables</span>
<span class="n">hist</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Repeating the same for validation set</span>
<span class="n">hist</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="n">hist</span><span class="p">[[</span><span class="s1">&#39;hist_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hist</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">behaviors_valid</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">max_hist</span><span class="p">,</span><span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)[[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">max_hist</span><span class="o">+</span><span class="mi">1</span><span class="p">)]]</span>

<span class="n">hist</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news_index</span><span class="p">],[</span><span class="nb">str</span><span class="p">(</span><span class="n">news_index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news_index</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

<span class="n">behaviors_valid</span><span class="p">[[</span><span class="s1">&#39;hist_cat_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hist</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">],[</span><span class="nb">int</span><span class="p">(</span><span class="n">news</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cat&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">])</span>

<span class="n">behaviors_valid</span><span class="p">[[</span><span class="s1">&#39;hist_subcat_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hist</span><span class="p">)]]</span> <span class="o">=</span> <span class="n">hist</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">],[</span><span class="nb">int</span><span class="p">(</span><span class="n">news</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;sub_cat&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">])</span>

<span class="n">behaviors_valid</span><span class="p">[</span><span class="s1">&#39;hist_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">behaviors_valid</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

<span class="n">behaviors_valid</span> <span class="o">=</span> <span class="n">behaviors_valid</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;history&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">hist</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pre-process-4-unroll-items-in-impression-column">
<h3>Pre-process 4 : Unroll items in impression column<a class="headerlink" href="#pre-process-4-unroll-items-in-impression-column" title="Permalink to this headline"></a></h3>
<p>As an example, consider the below expanded history column row from the behaviours dataframe:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-center head"><p>impression_id</p></th>
<th class="text-center head"><p>uid</p></th>
<th class="text-center head"><p>time</p></th>
<th class="text-center head"><p>hist_cat_0</p></th>
<th class="text-center head"><p>hist_cat_1</p></th>
<th class="text-center head"><p>hist_cat_2</p></th>
<th class="text-center head"><p>…</p></th>
<th class="text-center head"><p>hist_subcat_3</p></th>
<th class="text-center head"><p>hist_subcat_4</p></th>
<th class="text-center head"><p>hist_subcat_5</p></th>
<th class="text-center head"><p>impressions</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>1</p></td>
<td class="text-center"><p>U64099</p></td>
<td class="text-center"><p>11/19/2019 11:37:45 AM</p></td>
<td class="text-center"><p>sports</p></td>
<td class="text-center"><p>finance</p></td>
<td class="text-center"><p>entertainment</p></td>
<td class="text-center"><p>…</p></td>
<td class="text-center"><p>markets</p></td>
<td class="text-center"><p>celebrity</p></td>
<td class="text-center"><p>football_nfl</p></td>
<td class="text-center"><p>N78206-0 N26368-1 N7578-1 N58592-0 N19858-0</p></td>
</tr>
</tbody>
</table>
<p>The impression column contains the positive and negetive samples as a long string.</p>
<p>After unrolling one row of impressions into multiple rows, the resulting dataframe would look like this:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-center head"><p>impression_id</p></th>
<th class="text-center head"><p>uid</p></th>
<th class="text-center head"><p>time</p></th>
<th class="text-center head"><p>hist_cat_0</p></th>
<th class="text-center head"><p>hist_cat_1</p></th>
<th class="text-center head"><p>hist_cat_2</p></th>
<th class="text-center head"><p>…</p></th>
<th class="text-center head"><p>hist_subcat_3</p></th>
<th class="text-center head"><p>hist_subcat_4</p></th>
<th class="text-center head"><p>hist_subcat_5</p></th>
<th class="text-center head"><p>impressions</p></th>
<th class="text-center head"><p>label</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>1</p></td>
<td class="text-center"><p>U64099</p></td>
<td class="text-center"><p>11/19/2019 11:37:45 AM</p></td>
<td class="text-center"><p>sports</p></td>
<td class="text-center"><p>finance</p></td>
<td class="text-center"><p>entertainment</p></td>
<td class="text-center"><p>…</p></td>
<td class="text-center"><p>markets</p></td>
<td class="text-center"><p>celebrity</p></td>
<td class="text-center"><p>football_nfl</p></td>
<td class="text-center"><p>N78206</p></td>
<td class="text-center"><p>0</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>1</p></td>
<td class="text-center"><p>U64099</p></td>
<td class="text-center"><p>11/19/2019 11:37:45 AM</p></td>
<td class="text-center"><p>sports</p></td>
<td class="text-center"><p>finance</p></td>
<td class="text-center"><p>entertainment</p></td>
<td class="text-center"><p>…</p></td>
<td class="text-center"><p>markets</p></td>
<td class="text-center"><p>celebrity</p></td>
<td class="text-center"><p>football_nfl</p></td>
<td class="text-center"><p>N26368</p></td>
<td class="text-center"><p>1</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>1</p></td>
<td class="text-center"><p>U64099</p></td>
<td class="text-center"><p>11/19/2019 11:37:45 AM</p></td>
<td class="text-center"><p>sports</p></td>
<td class="text-center"><p>finance</p></td>
<td class="text-center"><p>entertainment</p></td>
<td class="text-center"><p>…</p></td>
<td class="text-center"><p>markets</p></td>
<td class="text-center"><p>celebrity</p></td>
<td class="text-center"><p>football_nfl</p></td>
<td class="text-center"><p>N7578</p></td>
<td class="text-center"><p>1</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>1</p></td>
<td class="text-center"><p>U64099</p></td>
<td class="text-center"><p>11/19/2019 11:37:45 AM</p></td>
<td class="text-center"><p>sports</p></td>
<td class="text-center"><p>finance</p></td>
<td class="text-center"><p>entertainment</p></td>
<td class="text-center"><p>…</p></td>
<td class="text-center"><p>markets</p></td>
<td class="text-center"><p>celebrity</p></td>
<td class="text-center"><p>football_nfl</p></td>
<td class="text-center"><p>N58592</p></td>
<td class="text-center"><p>0</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>1</p></td>
<td class="text-center"><p>U64099</p></td>
<td class="text-center"><p>11/19/2019 11:37:45 AM</p></td>
<td class="text-center"><p>sports</p></td>
<td class="text-center"><p>finance</p></td>
<td class="text-center"><p>entertainment</p></td>
<td class="text-center"><p>…</p></td>
<td class="text-center"><p>markets</p></td>
<td class="text-center"><p>celebrity</p></td>
<td class="text-center"><p>football_nfl</p></td>
<td class="text-center"><p>N19858</p></td>
<td class="text-center"><p>0</p></td>
</tr>
</tbody>
</table>
<p>Note that all the 5 generated rows have the same impression_id, uid, time and history data columns.</p>
<p>We have observed that the maximum number of items in impression column is 105 and the mean is 40. <br>
We will limit the items to unroll from impression column by defining the variable <code class="docutils literal notranslate"><span class="pre">max_impr</span></code> and set it to 100. Feel free to increase or decrease this value.</p>
<p><strong>Note</strong> - Make sure you’re using a GPU with atleast 16GB memory to avoid OOM errors with the below set values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_impr</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
</div>
<p>Row expansion is a memory and I/O intensive operation thus, we will perform it in 2 steps. We will first create a dictionary with impression-label and later merge it with the train set.</p>
<p>Let’s convert impression column as dictionary of list with impression id as key and the impression items as value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For train dataset</span>
<span class="n">impr_train</span> <span class="o">=</span> <span class="n">behaviors_train</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;impression_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">impressions</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">impr_train</span> <span class="o">=</span> <span class="n">impr_train</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="n">behaviors_train</span> <span class="o">=</span> <span class="n">behaviors_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;impressions&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># For validation dataset</span>
<span class="n">impr_valid</span> <span class="o">=</span> <span class="n">behaviors_valid</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;impression_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">impressions</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">impr_valid</span> <span class="o">=</span> <span class="n">impr_valid</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
<span class="n">behaviors_valid</span> <span class="o">=</span> <span class="n">behaviors_valid</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;impressions&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Since the number of negative samples (labelled with 0) are greater than the positive samples, we can define a ratio between the negatives and positives to sampling a balanced distribution. <br>
For now, let’s set this variable to -1 to include all the samples from the impression column. Feel free to set this variable to a value greater than 1 to downsample the negative samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np_ratio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># ratio of neg-to-pos samples</span>
</pre></div>
</div>
</div>
</div>
<p>Iterating over the above dictionary to create a new dataframe with individual impression news in a new row with its corresponding label.<br>
This is a time consuming operation!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For train set</span>

<span class="n">imp_id</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">imp_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">imp_label</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">impr_train</span><span class="p">,</span><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">impr_train</span><span class="p">)):</span>
    <span class="n">imp</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([[</span><span class="n">news_index</span><span class="p">[</span><span class="n">imp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span><span class="n">imp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">impr_train</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">neg</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imp</span><span class="p">),</span><span class="n">max_impr</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="ow">and</span> <span class="n">np_ratio</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">neg</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="o">*</span><span class="n">np_ratio</span> <span class="p">:</span>
                <span class="n">imp_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">imp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">imp_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">neg</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imp_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">imp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">imp_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

<span class="n">impr_train</span> <span class="o">=</span> <span class="kc">None</span> 

<span class="c1"># Creating a new gdf with impression id, news id and its label</span>
<span class="n">impressions_train</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;imp_id&#39;</span><span class="p">:</span> <span class="n">imp_id</span><span class="p">,</span><span class="s1">&#39;impr&#39;</span><span class="p">:</span> <span class="n">imp_list</span><span class="p">,</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">imp_label</span><span class="p">})</span>

<span class="c1"># Appending news category corresponding to above impression news in the above created DataFrame</span>
<span class="n">impressions_train</span><span class="p">[</span><span class="s1">&#39;impr_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">impressions_train</span><span class="p">[</span><span class="s1">&#39;impr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">],[</span><span class="nb">int</span><span class="p">(</span><span class="n">news</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cat&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">])</span>

<span class="c1"># Appending news sub-category corresponding to above impression news in above created DataFrame</span>
<span class="n">impressions_train</span><span class="p">[</span><span class="s1">&#39;impr_subcat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">impressions_train</span><span class="p">[</span><span class="s1">&#39;impr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">],[</span><span class="nb">int</span><span class="p">(</span><span class="n">news</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;sub_cat&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">])</span>

<span class="c1"># Droping impr columns as news data is added for it.</span>
<span class="n">impressions_train</span> <span class="o">=</span> <span class="n">impressions_train</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;impr&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">impressions_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For validation set</span>

<span class="n">imp_id</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">imp_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">imp_label</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">impr_valid</span><span class="p">,</span><span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">impr_valid</span><span class="p">)):</span>
    <span class="n">imp</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([[</span><span class="n">news_index</span><span class="p">[</span><span class="n">imp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],</span><span class="n">imp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="n">impr_valid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">neg</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imp</span><span class="p">),</span><span class="n">max_impr</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span> <span class="ow">and</span> <span class="n">np_ratio</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">neg</span> <span class="o">&lt;=</span> <span class="n">pos</span><span class="o">*</span><span class="n">np_ratio</span> <span class="p">:</span>
                <span class="n">imp_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">imp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">imp_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">neg</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imp_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">imp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imp</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">imp_label</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

<span class="n">impr_valid</span> <span class="o">=</span> <span class="kc">None</span> 

<span class="n">impressions_valid</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;imp_id&#39;</span><span class="p">:</span> <span class="n">imp_id</span><span class="p">,</span><span class="s1">&#39;impr&#39;</span><span class="p">:</span> <span class="n">imp_list</span><span class="p">,</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">imp_label</span><span class="p">})</span>
<span class="n">impressions_valid</span><span class="p">[</span><span class="s1">&#39;impr_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">impressions_valid</span><span class="p">[</span><span class="s1">&#39;impr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">],[</span><span class="nb">int</span><span class="p">(</span><span class="n">news</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cat&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">])</span>
<span class="n">impressions_valid</span><span class="p">[</span><span class="s1">&#39;impr_subcat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">impressions_valid</span><span class="p">[</span><span class="s1">&#39;impr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">],[</span><span class="nb">int</span><span class="p">(</span><span class="n">news</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;sub_cat&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">news</span><span class="p">])</span>
<span class="n">impressions_valid</span> <span class="o">=</span> <span class="n">impressions_valid</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;impr&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">impressions_valid</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Freeing up memory by nulling variables</span>
<span class="n">imp_id</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">imp_list</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">imp_label</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pre-process-5-merge-behaviour-and-news-datasets">
<h3>Pre-process 5: Merge behaviour and news datasets<a class="headerlink" href="#pre-process-5-merge-behaviour-and-news-datasets" title="Permalink to this headline"></a></h3>
<p>Collating all the required columns from both behaviours and news dataset would make the feature engineering process much more faster.</p>
<p>We will merge the history columns (from behaviors dataframe) with the above created impression data and save it as a parquet file. <br>
We will also re-initialize RMM to allow us to perform memory intensive merge operation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For training set</span>
<span class="n">rmm</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">(</span><span class="n">managed_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">final_data</span> <span class="o">=</span> <span class="n">impressions_train</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">behaviors_train</span><span class="p">,</span><span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;imp_id&#39;</span><span class="p">],</span><span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;impression_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;imp_id&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">final_data</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">final_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span><span class="n">final_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">final_data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">,</span> <span class="s1">&#39;train.parquet&#39;</span><span class="p">),</span> <span class="n">compression</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Freeing up memory by nulling variables</span>
<span class="n">final_data</span><span class="o">=</span><span class="kc">None</span>
<span class="n">impressions_train</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">behaviors_train</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">#client.run(_rmm_pool)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For validation set</span>

<span class="n">final_data</span> <span class="o">=</span> <span class="n">impressions_valid</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">behaviors_valid</span><span class="p">,</span><span class="n">left_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;imp_id&#39;</span><span class="p">],</span><span class="n">right_on</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;impression_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;imp_id&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">final_data</span> <span class="o">=</span> <span class="n">cudf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">final_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span><span class="n">final_data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">final_data</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">,</span> <span class="s1">&#39;valid.parquet&#39;</span><span class="p">),</span><span class="n">compression</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># Freeing up memory by nulling variables</span>
<span class="n">final_data</span><span class="o">=</span><span class="kc">None</span>
<span class="n">impressions_valid</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">behaviors_valid</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we have our initial pre-processed data - <strong>train.parquet</strong> and <strong>valid.parquet</strong> - that would be used for feature engineering and further processing.</p>
</div>
</div>
<div class="section" id="step-5-feature-engineering-time-based-features">
<h2>Step 5: Feature Engineering - time-based features<a class="headerlink" href="#step-5-feature-engineering-time-based-features" title="Permalink to this headline"></a></h2>
<p>To get started with NVTabular, we’ll first use it for creating simple time based features that would be extracted from the timestamp column in the behaviours data. <br></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Declaring features of train set that we created</span>

<span class="n">cat_features</span> <span class="o">=</span> <span class="p">[</span>
 <span class="s1">&#39;hist_cat_0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_1&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_1&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_3&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_3&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_4&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_4&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_5&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_5&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_6&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_6&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_7&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_7&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_8&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_8&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_9&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_9&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impr_cat&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impr_subcat&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impression_id&#39;</span><span class="p">,</span>
 <span class="s1">&#39;uid&#39;</span><span class="p">]</span>

<span class="n">cont_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hist_count&#39;</span><span class="p">]</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating time based features by extracting the relevant elements using cuDF</span>

<span class="n">datetime</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ColumnGroup</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">cudf</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y %I:%M:%S %p&quot;</span><span class="p">))</span>

<span class="n">hour</span> <span class="o">=</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_hour&#39;</span><span class="p">)</span>
<span class="n">minute</span> <span class="o">=</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_minute&#39;</span><span class="p">)</span>
<span class="n">seconds</span> <span class="o">=</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_second&#39;</span><span class="p">)</span>

<span class="n">weekday</span> <span class="o">=</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_wd&#39;</span><span class="p">)</span>
<span class="n">day</span> <span class="o">=</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">cudf</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_day&#39;</span><span class="p">)</span>

<span class="n">week</span> <span class="o">=</span> <span class="n">day</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="p">(</span><span class="n">col</span><span class="o">/</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_week&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To create embedding tables and segregate the pre-processing functions (normalization, fill missing values etc.) among categorical and continous features, we define and pipeline them using NVTabular’s operator overloading.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat_features</span> <span class="o">=</span> <span class="n">cat_features</span> <span class="o">+</span> <span class="n">hour</span> <span class="o">+</span> <span class="n">minute</span> <span class="o">+</span> <span class="n">seconds</span> <span class="o">+</span> <span class="n">weekday</span> <span class="o">+</span> <span class="n">day</span> <span class="o">+</span> <span class="n">week</span> <span class="o">+</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Categorify</span><span class="p">(</span><span class="n">out_path</span> <span class="o">=</span> <span class="n">data_output_path</span><span class="p">)</span>
<span class="n">cont_features</span> <span class="o">=</span> <span class="n">cont_features</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">FillMissing</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">NormalizeMinMax</span><span class="p">()</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We can visualize the complete workflow pipeline.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">cat_features</span> <span class="o">+</span> <span class="n">cont_features</span>
<span class="n">output</span><span class="o">.</span><span class="n">graph</span>
</pre></div>
</div>
</div>
</div>
<p>To run this graph, we would create a workflow object that calculates statistics and performs the relevant transformations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">cat_features</span> <span class="o">+</span> <span class="n">cont_features</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize a nvt.Dataset from parquet file that was created in step 4.</span>

<span class="n">data_train</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">,</span> <span class="s2">&quot;train.parquet&quot;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">,</span><span class="n">part_size</span><span class="o">=</span><span class="s2">&quot;256MB&quot;</span><span class="p">)</span>
<span class="n">data_valid</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">,</span> <span class="s2">&quot;valid.parquet&quot;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">,</span><span class="n">part_size</span><span class="o">=</span><span class="s2">&quot;256MB&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Since we are going to train the DNNs using HugeCTR, we need to conform to the following dtypes:</p>
<ul class="simple">
<li><p>categorical feature columns in int64</p></li>
<li><p>continuous feature columns in float32</p></li>
<li><p>label columns in float32</p></li>
</ul>
<p>We will make a dictionary containing names of columns as key and the required datatype as value. This dictionary will be used by NVTabular for type casting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_dtypes</span><span class="o">=</span><span class="p">{}</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cat_features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cont_features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s fit the workflow on the training set to record the statistics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">proc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we apply the transformation to the dataset and persist it to disk as parquet.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="c1"># For training set</span>
<span class="n">proc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span> <span class="n">output_train_path</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="n">nvt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Shuffle</span><span class="o">.</span><span class="n">PER_PARTITION</span><span class="p">,</span>
                                <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">,</span>
                                <span class="n">out_files_per_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">cats</span> <span class="o">=</span> <span class="n">cat_features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                <span class="n">conts</span> <span class="o">=</span> <span class="n">cont_features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="c1"># For validation set</span>
<span class="n">proc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span> <span class="n">output_valid_path</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="n">nvt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Shuffle</span><span class="o">.</span><span class="n">PER_PARTITION</span><span class="p">,</span>
                                <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">,</span>
                                <span class="n">out_files_per_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">cats</span> <span class="o">=</span> <span class="n">cat_features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                <span class="n">conts</span> <span class="o">=</span> <span class="n">cont_features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s load the NVTabular processed parquet files and look at our first NVTabular pre-processed dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">dask_cudf</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_train_path</span><span class="p">,</span> <span class="s1">&#39;*.parquet&#39;</span><span class="p">))</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>After transformation and persisting the data on the disk, the following files will be created:</p>
<ol class="arabic simple">
<li><p>parquet</p>
<ul class="simple">
<li><p>The number of parquet files depends on <code class="docutils literal notranslate"><span class="pre">out_files_per_proc</span></code> in <code class="docutils literal notranslate"><span class="pre">proc_train.transform()</span></code></p></li>
</ul>
</li>
<li><p>_file_list.txt</p>
<ul class="simple">
<li><p>The 1st line contains the number of parquet files</p></li>
<li><p>The subsequent lines are the paths to each parquet file.</p></li>
</ul>
</li>
<li><p>_metadata.json</p>
<ul class="simple">
<li><p>This file is used by HugeCTR in parsing the processed parquet files.</p></li>
<li><p>‘file_stats’ contains the name of the parquet files and their corresponding number of rows.</p></li>
<li><p>‘cats’ is a list of categorical features/columns in the dataset and their index.</p></li>
<li><p>‘conts’ is a list of continous/dense columns in the dataset and their index.</p></li>
<li><p>‘labels’ is a list of labels in the dataset and their index.</p></li>
<li><p>This file shouldn’t be edited manually.</p></li>
</ul>
</li>
</ol>
<p>Let’s look at the contents of _metadata.json</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_train_path</span><span class="p">,</span> <span class="s1">&#39;_metadata.json&#39;</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">metadata</span>
</pre></div>
</div>
</div>
</div>
<p>Next, we need to get the embedding size for the categorical variables. This will be an important input for defining the embedding table size to be used by HugeCTR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nvtabular.ops</span> <span class="kn">import</span> <span class="n">get_embedding_sizes</span>
<span class="n">embeddings_simple_time</span> <span class="o">=</span> <span class="n">get_embedding_sizes</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
<span class="n">embeddings_simple_time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reformatting the above output for ease of copy paste in HugeCTRs config.json</span>

<span class="n">embedding_size_str_simple_time</span> <span class="o">=</span> <span class="p">[</span><span class="n">embeddings_simple_time</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cat_features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">embedding_size_str_simple_time</span>
</pre></div>
</div>
</div>
</div>
<p>We can also check the name of the categorical and continuous features that we’ve defined. This should match with the cats and conts dictionaries in the _metadata.json</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat_features</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cont_features</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
</div>
<p>Before moving on to training a DNN, let’s try few complex feature engineering techniques using NVTabular. We would later train DNNs on both these feature engineered dataset and compare their performances.</p>
</div>
<div class="section" id="step-6-feature-engineering-count-and-target-encoding">
<h2>Step 6: Feature Engineering - count and target encoding<a class="headerlink" href="#step-6-feature-engineering-count-and-target-encoding" title="Permalink to this headline"></a></h2>
<p>We will now perform count and target encoding on the processed dataset generated in step 5. Let’s start by defining directories for the input dataset and the output processed dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define our worker/output directories</span>
<span class="n">dask_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;workdir&quot;</span><span class="p">)</span>

<span class="c1"># Mapping our processed_nvt output directories as input directories for new workflow.</span>
<span class="n">data_input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;dataset&quot;</span><span class="p">)</span>

<span class="c1"># Defining new directories for output</span>
<span class="n">data_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;processed_ce-te&quot;</span><span class="p">)</span>
<span class="n">output_train_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">,</span> <span class="s2">&quot;train&quot;</span><span class="p">)</span>
<span class="n">output_valid_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">)</span>

<span class="c1"># Creating and cleaning our worker/output directories</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Ensure BASE_DIR exists</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">)</span>
        
    <span class="c1"># Make sure we have a clean worker space for Dask</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dask_workdir</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dask_workdir</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dask_workdir</span><span class="p">)</span>

    <span class="c1"># Make sure we have a clean output path for our new dataset</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">)</span>
        
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">data_output_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_train_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_valid_path</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Creation of the directories failed&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Successfully created the directories&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As you would observe, we have created a new directory by the name <code class="docutils literal notranslate"><span class="pre">processed_ce-te</span></code>. The complete directory structure now is:</p>
<p>basedir <br>
  |— workdir<br />
  |— dataset <br>
    |— train <br>
    |— valid  <br>
  |— processed_nvt <br>
     |— train <br>
     |— valid  <br>
  |— processed_ce-te <br>
     |— train <br>
     |— valid  <br>
  |— configs <br>
  |— weights <br></p>
<p>Again, defining the categorical and continous features based on processed data generated in step-5.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hist_cat_0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_1&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_1&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_3&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_3&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_4&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_4&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_5&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_5&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_6&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_6&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_7&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_7&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_8&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_8&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_9&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_9&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impr_cat&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impr_subcat&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impression_id&#39;</span><span class="p">,</span>
 <span class="s1">&#39;uid&#39;</span><span class="p">,]</span>

<span class="n">cont_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hist_count&#39;</span><span class="p">]</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Count Encoding</strong> calculates the frequency of one or more categorical features. For the purpose of this tutorial, we will count how often the user had clicked on news with the same category/sub-category in a given impression.</p>
<p>To calculate the occurence of the same news category/sub-category in history, we will iterate over the group of rows with the same impression id. We will also consider the category/sub-category of the impression news.<br>
Let’s start by defining supportive functions for counting the category and subcategory from history columns. This supportive function will be used by <code class="docutils literal notranslate"><span class="pre">apply_rows()</span></code> in LambdaOp <code class="docutils literal notranslate"><span class="pre">create_count_features</span></code></p>
<p>We can also limit the number of history columns to be considered for count encoding. For now, let’s use all the history columns that we have in the dataset i.e. all 10.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">max_hist</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_cat_count</span><span class="p">(</span>
         <span class="n">hist_cat_0</span><span class="p">,</span>
         <span class="n">hist_cat_1</span><span class="p">,</span>
         <span class="n">hist_cat_2</span><span class="p">,</span>
         <span class="n">hist_cat_3</span><span class="p">,</span>
         <span class="n">hist_cat_4</span><span class="p">,</span>
         <span class="n">hist_cat_5</span><span class="p">,</span>
         <span class="n">hist_cat_6</span><span class="p">,</span>
         <span class="n">hist_cat_7</span><span class="p">,</span>
         <span class="n">hist_cat_8</span><span class="p">,</span>
         <span class="n">hist_cat_9</span><span class="p">,</span>
         <span class="n">impr_cat</span><span class="p">,</span>
         <span class="n">impr_cat_count</span><span class="p">,</span>
         <span class="n">k</span><span class="p">):</span>
    
    <span class="c1"># Following loop iterates over each row of columns hist_cat_0-&gt;9 and impr_cat</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">hist_cat_0</span><span class="p">,</span>
                                 <span class="n">hist_cat_1</span><span class="p">,</span>
                                 <span class="n">hist_cat_2</span><span class="p">,</span>
                                 <span class="n">hist_cat_3</span><span class="p">,</span>
                                 <span class="n">hist_cat_4</span><span class="p">,</span>
                                 <span class="n">hist_cat_5</span><span class="p">,</span>
                                 <span class="n">hist_cat_6</span><span class="p">,</span>
                                 <span class="n">hist_cat_7</span><span class="p">,</span>
                                 <span class="n">hist_cat_8</span><span class="p">,</span>
                                 <span class="n">hist_cat_9</span><span class="p">,</span>
                                 <span class="n">impr_cat</span><span class="p">,</span>
                                <span class="p">)):</span>
        
        <span class="c1"># Iterate over each column and check if history category matches with impression category.</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1"># Update the count in the corresponding row of output column (impr_cat_count)</span>
        <span class="n">impr_cat_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_subcat_count</span><span class="p">(</span>
         <span class="n">hist_subcat_0</span><span class="p">,</span>
         <span class="n">hist_subcat_1</span><span class="p">,</span>
         <span class="n">hist_subcat_2</span><span class="p">,</span>
         <span class="n">hist_subcat_3</span><span class="p">,</span>
         <span class="n">hist_subcat_4</span><span class="p">,</span>
         <span class="n">hist_subcat_5</span><span class="p">,</span>
         <span class="n">hist_subcat_6</span><span class="p">,</span>
         <span class="n">hist_subcat_7</span><span class="p">,</span>
         <span class="n">hist_subcat_8</span><span class="p">,</span>
         <span class="n">hist_subcat_9</span><span class="p">,</span>
         <span class="n">impr_subcat</span><span class="p">,</span>
         <span class="n">impr_subcat_count</span><span class="p">,</span>
         <span class="n">k</span><span class="p">):</span>
    
    <span class="c1"># Following loop iterates over each row of columns hist_subcat_0-&gt;9 and impr_cat</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                                 <span class="n">hist_subcat_0</span><span class="p">,</span>
                                 <span class="n">hist_subcat_1</span><span class="p">,</span>
                                 <span class="n">hist_subcat_2</span><span class="p">,</span>
                                 <span class="n">hist_subcat_3</span><span class="p">,</span>
                                 <span class="n">hist_subcat_4</span><span class="p">,</span>
                                 <span class="n">hist_subcat_5</span><span class="p">,</span>
                                 <span class="n">hist_subcat_6</span><span class="p">,</span>
                                 <span class="n">hist_subcat_7</span><span class="p">,</span>
                                 <span class="n">hist_subcat_8</span><span class="p">,</span>
                                 <span class="n">hist_subcat_9</span><span class="p">,</span>
                                 <span class="n">impr_subcat</span><span class="p">,</span>
                                <span class="p">)):</span>

        <span class="c1"># Iterate over each column and check if history sub-category matches with impression sub-category.</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">temp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>      
        <span class="c1"># Update the count(occurence) in corresponding row of output column (impr_cat_count)        </span>
        <span class="n">impr_subcat_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
</pre></div>
</div>
</div>
</div>
<p>To add the count encoding for ‘categories’ and ‘sub_categories’ to each row for their corresponding news_id, we will write a LambdaOp by simply inhereting from NVTabular’s <code class="docutils literal notranslate"><span class="pre">Operator</span></code> class and defining the <code class="docutils literal notranslate"><span class="pre">transform</span></code> and <code class="docutils literal notranslate"><span class="pre">output_column_names</span></code> methods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">create_count_features</span><span class="p">(</span><span class="n">Operator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">gdf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;impr_cat&#39;</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">apply_rows</span><span class="p">(</span><span class="n">add_cat_count</span><span class="p">,</span><span class="n">incols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hist_cat_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hist</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;impr_cat&#39;</span><span class="p">],</span><span class="n">outcols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;impr_cat_count&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">},</span><span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="k">return</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;impr_subcat&#39;</span><span class="p">:</span>
            <span class="n">gdf</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">apply_rows</span><span class="p">(</span><span class="n">add_subcat_count</span><span class="p">,</span><span class="n">incols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hist_subcat_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hist</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;impr_subcat&#39;</span><span class="p">],</span><span class="n">outcols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;impr_subcat_count&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">},</span><span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="k">return</span><span class="p">(</span><span class="n">gdf</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">output_column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;impr_cat&#39;</span><span class="p">:</span>
            <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;impr_cat_count&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;impr_subcat&#39;</span><span class="p">:</span>
            <span class="n">col</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;impr_subcat_count&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">col</span>

    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Target encoding</strong> is used to average the target value by some category/group. This technique is used to find numeric mean relationship between the categorical features and target.</p>
<p>We have observed that the hist_cat columns are the most suitable for target encoding. Rather than using just 1 history category column, we also found that a group of history columns encode better probabilities with the target variable.</p>
<p>For this tutorial, we are going use 5 history category columns, in a moving window fashion, along with the impression category column to calculate the target encoding.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">te_columns</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;hist_cat_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">5</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;impr_cat&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_hist</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">target_encode</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">te_columns</span> <span class="o">&gt;&gt;</span>
    <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">TargetEncoding</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">BASE_DIR</span><span class="p">,</span>
        <span class="n">kfold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">p_smooth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">out_dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll also create the time based features in the same way as we did in step-6.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">datetime</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ColumnGroup</span><span class="p">([</span><span class="s1">&#39;time&#39;</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">cudf</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">col</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y %I:%M:%S %p&quot;</span><span class="p">))</span>

<span class="n">hour</span> <span class="o">=</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_hour&#39;</span><span class="p">)</span>
<span class="n">minute</span> <span class="o">=</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_minute&#39;</span><span class="p">)</span>
<span class="n">seconds</span> <span class="o">=</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_second&#39;</span><span class="p">)</span>

<span class="n">weekday</span> <span class="o">=</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekday</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_wd&#39;</span><span class="p">)</span>
<span class="n">day</span> <span class="o">=</span> <span class="n">datetime</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="n">cudf</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_day&#39;</span><span class="p">)</span>

<span class="n">week</span> <span class="o">=</span> <span class="n">day</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">col</span><span class="p">:</span> <span class="p">(</span><span class="n">col</span><span class="o">/</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">floor</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_week&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat_count_encode</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hist_cat_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hist</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;impr_cat&#39;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">create_count_features</span><span class="p">()</span>

<span class="n">subcat_count_encode</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hist_subcat_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_hist</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;impr_subcat&#39;</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">create_count_features</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cat_features</span> <span class="o">=</span> <span class="n">cat_features</span> <span class="o">+</span> <span class="n">datetime</span> <span class="o">+</span> <span class="n">hour</span> <span class="o">+</span> <span class="n">minute</span> <span class="o">+</span> <span class="n">seconds</span> <span class="o">+</span> <span class="n">weekday</span> <span class="o">+</span> <span class="n">day</span> <span class="o">+</span> <span class="n">week</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Categorify</span><span class="p">(</span><span class="n">out_path</span> <span class="o">=</span> <span class="n">data_output_path</span><span class="p">)</span>
<span class="n">cont_features</span> <span class="o">=</span> <span class="n">cont_features</span> <span class="o">+</span> <span class="n">cat_count_encode</span> <span class="o">+</span> <span class="n">subcat_count_encode</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">FillMissing</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">NormalizeMinMax</span><span class="p">()</span>
<span class="n">cont_features</span> <span class="o">+=</span> <span class="n">target_encode</span> <span class="o">&gt;&gt;</span> <span class="n">nvt</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">Rename</span><span class="p">(</span><span class="n">postfix</span> <span class="o">=</span> <span class="s1">&#39;_TE&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can visualize the complete workflow pipeline.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">cat_features</span> <span class="o">+</span> <span class="n">cont_features</span>
<span class="n">output</span><span class="o">.</span><span class="n">graph</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proc</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">cat_features</span> <span class="o">+</span> <span class="n">cont_features</span> <span class="o">+</span> <span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>We initialize a nvt.Dataset object from parquet dataset that was created in step 5.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_train</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">,</span> <span class="s2">&quot;train.parquet&quot;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">,</span><span class="n">part_size</span><span class="o">=</span><span class="s2">&quot;256MB&quot;</span><span class="p">)</span>
<span class="n">data_valid</span> <span class="o">=</span> <span class="n">nvt</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_input_path</span><span class="p">,</span> <span class="s2">&quot;valid.parquet&quot;</span><span class="p">),</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">,</span><span class="n">part_size</span><span class="o">=</span><span class="s2">&quot;256MB&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dict_dtypes</span><span class="o">=</span><span class="p">{}</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cat_features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cont_features</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
    <span class="n">dict_dtypes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s fit the workflow on our training dataset to record the statistics.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">proc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="c1"># For training set</span>
<span class="n">proc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_train</span><span class="p">)</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">output_train_path</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="n">nvt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Shuffle</span><span class="o">.</span><span class="n">PER_PARTITION</span><span class="p">,</span>
                                <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">,</span>
                                <span class="n">out_files_per_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">cats</span> <span class="o">=</span> <span class="n">cat_features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                <span class="n">conts</span> <span class="o">=</span> <span class="n">cont_features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>

<span class="c1"># For validation set</span>
<span class="n">proc</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">data_valid</span><span class="p">)</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">output_path</span><span class="o">=</span><span class="n">output_valid_path</span><span class="p">,</span>
                                <span class="n">shuffle</span><span class="o">=</span><span class="n">nvt</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">Shuffle</span><span class="o">.</span><span class="n">PER_PARTITION</span><span class="p">,</span>
                                <span class="n">dtypes</span><span class="o">=</span><span class="n">dict_dtypes</span><span class="p">,</span>
                                <span class="n">out_files_per_proc</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                <span class="n">cats</span> <span class="o">=</span> <span class="n">cat_features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                <span class="n">conts</span> <span class="o">=</span> <span class="n">cont_features</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">)</span>
<span class="n">rmm</span><span class="o">.</span><span class="n">reinitialize</span><span class="p">(</span><span class="n">managed_memory</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s take a quick look at the contents of _metadata.json</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_train_path</span><span class="p">,</span> <span class="s1">&#39;_metadata.json&#39;</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="n">metadata</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nvtabular.ops</span> <span class="kn">import</span> <span class="n">get_embedding_sizes</span>
<span class="n">embeddings_count_encode</span> <span class="o">=</span>  <span class="n">get_embedding_sizes</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
<span class="n">embeddings_count_encode</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reformatting the above output for ease of copy paste in HugeCTRs config.json</span>

<span class="n">embedding_size_str_count_encode</span> <span class="o">=</span> <span class="p">[</span><span class="n">embeddings_count_encode</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cat_features</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">embedding_size_str_count_encode</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have 2 versions of our dataset ready, one with time based features and other with count + target encoded features, we can start training a few DNNs using HugeCTR.</p>
</div>
<div class="section" id="step-7-train-dnn-with-hugectr">
<h2>Step 7: Train DNN with HugeCTR<a class="headerlink" href="#step-7-train-dnn-with-hugectr" title="Permalink to this headline"></a></h2>
<p>In this section, we would be training Deep Learning Recommendation Model (DLRM) using HugeCTR’s low level python API. We would also be using the inference python API for evaluation on the validation set.</p>
<p>We would be training 2 models, one each for the 2 datasets that we’ve processed.</p>
<div class="section" id="train-config-json-for-simple-time-based-features-dataset">
<h3>Train config json for simple time based features dataset<a class="headerlink" href="#train-config-json-for-simple-time-based-features-dataset" title="Permalink to this headline"></a></h3>
<p>Python low level train API requires a train config.json with the arguments and definitions of various training parameters like - optimizer, iterations, neural architecture and dataset.<br>
As a first step, we will develop this config file for our feature engineered dataset and DLRM model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define paths to save the config and the weights</span>

<span class="n">config_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_output_path</span><span class="p">,</span><span class="s1">&#39;dlrm_fp32_simple-time_1gpu.json&#39;</span><span class="p">)</span>
<span class="n">weights_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">weights_path</span><span class="p">,</span><span class="s1">&#39;dlrm_fp32_simple-time_1gpu/&#39;</span><span class="p">)</span>

<span class="c1"># Creating Directory inside weights folder</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">weights_output_path</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">weights_output_path</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">weights_output_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For DLRM model, lets consider the <a class="reference external" href="https://github.com/NVIDIA/HugeCTR/tree/v2.3/samples/dlrm/">dlrm_fp32_64k.json</a> sample file that is available on HugeCTR’s github repository, and modify it for our dataset.</p>
<p>The parameters that we should modify are:</p>
<ul class="simple">
<li><p>solver:
- max_iter: Num. of samples / batch size
- gpu: List of GPU IDs to use for training
- batchsize: num. of samples to process in the batch training mode
- eval_interval: Num. of iterations after which evaluation should trigger on the validation set</p></li>
<li><p>optimizer:
- type: Adam
- learning_rate: 1e-4 (smaller value to begin with)</p></li>
<li><p>layers
- format: Parquet (since our dataset is in parquet)
- source and eval_source: Path to _file_list.txt for the train and eval dataset produced by NVTabular
- slot_num: For LocalizedSlot, set it to the number of categorical features
- max_feature_num_per_sample: For LocalizedSlot, this can be the same as slot_num
- slot_size_array: Cardinality of the categorical features (in the same order as column names in ‘cats’ dictionary of _metadata.json)
- embedding_vec_size: dimension of the embedding vectors for the categorical features
- label_dim: Labels dimension
- dense_dim: Number of dense/continous features
- sparse: Dimensions of categorical features
- DLRM layer fc3: Output dimension of fc3 should be the same as embedding_vec_size</p></li>
</ul>
<p>We’ve developed one such train config.json below with the appropriate path to the dataset and default batch size for a 32GB GPU.<br>
Let’s make use of the data path and other variables we’ve defined in the steps above and re-define the ones which may have changed throughout the pre-processing step.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Path to the simple time based feature processed dataset</span>
<span class="n">output_train_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;processed_nvt/train&quot;</span><span class="p">)</span>
<span class="n">output_valid_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;processed_nvt/valid&quot;</span><span class="p">)</span>

<span class="c1"># Model related parameter</span>
<span class="n">embedding_vec_size</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Adam&quot;</span><span class="p">,</span>
        <span class="s2">&quot;update_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Local&quot;</span><span class="p">,</span>
        <span class="s2">&quot;adam_hparam&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
            <span class="s2">&quot;beta1&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
            <span class="s2">&quot;beta2&quot;</span><span class="p">:</span> <span class="mf">0.999</span><span class="p">,</span>
            <span class="s2">&quot;epsilon&quot;</span><span class="p">:</span> <span class="mf">1e-07</span><span class="p">,</span>
            <span class="s2">&quot;warmup_steps&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
            <span class="s2">&quot;decay_start&quot;</span><span class="p">:</span> <span class="mi">20000</span><span class="p">,</span>
            <span class="s2">&quot;decay_steps&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span>
            <span class="s2">&quot;decay_power&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;end_lr&quot;</span><span class="p">:</span> <span class="mf">0.000001</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;Parquet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;slot_size_array&quot;</span><span class="p">:</span> <span class="n">embedding_size_str_simple_time</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">output_train_path</span><span class="o">+</span><span class="s2">&quot;/_file_list.txt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eval_source&quot;</span><span class="p">:</span> <span class="n">output_valid_path</span><span class="o">+</span><span class="s2">&quot;/_file_list.txt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label_dim&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="s2">&quot;dense&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dense_dim&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="s2">&quot;sparse&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;data1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LocalizedSlot&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;max_feature_num_per_sample&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings_simple_time</span><span class="p">),</span>
                    <span class="s2">&quot;max_nnz&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;slot_num&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings_simple_time</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LocalizedSlotSparseEmbeddingHash&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;data1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sparse_embedding_hparam&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;slot_size_array&quot;</span><span class="p">:</span> <span class="n">embedding_size_str_simple_time</span><span class="p">,</span>
                <span class="s2">&quot;embedding_vec_size&quot;</span><span class="p">:</span> <span class="n">embedding_vec_size</span><span class="p">,</span>
                <span class="s2">&quot;combiner&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">512</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">256</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="n">embedding_vec_size</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu3&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Interaction&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;relu3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sparse_embedding1&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1024</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1024</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">512</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">256</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;loss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;BinaryCrossEntropyLoss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;fc8&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;loss&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="p">,</span>
    <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="n">layers</span>
<span class="p">}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, we can start the training using the above config file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">hugectr</span> <span class="kn">import</span> <span class="n">Session</span><span class="p">,</span> <span class="n">solver_parser_helper</span><span class="p">,</span><span class="n">get_learning_rate_scheduler</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>

<span class="c1"># Solver related parameters</span>
<span class="n">NUM_GPUS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>                                                     <span class="c1"># GPUs used for training</span>
<span class="n">json_file</span> <span class="o">=</span> <span class="n">config_file_path</span>                                       <span class="c1"># Path to the json config file</span>
<span class="n">batchsize</span> <span class="o">=</span> <span class="mi">2048</span>                                                   <span class="c1"># Batch size used for training</span>
<span class="n">batchsize_eval</span> <span class="o">=</span> <span class="mi">2048</span>                                              <span class="c1"># Batch size used for evaluation</span>
<span class="n">max_eval_batches</span> <span class="o">=</span> <span class="mi">3768</span>                                            <span class="c1"># Iterations required to go through the complete validation set with the set batchsize_eval</span>

<span class="c1"># Training related parameters</span>
<span class="n">num_iter</span> <span class="o">=</span> <span class="mi">30001</span>                                                   <span class="c1"># Iterations to train the model for</span>
<span class="n">eval_trigger</span> <span class="o">=</span> <span class="mi">10000</span>                                               <span class="c1"># Start evaluation after these iterations</span>
<span class="n">snapshot_trigger</span> <span class="o">=</span> <span class="mi">10000</span>                                           <span class="c1"># Save model checkpoints after these iterations</span>

<span class="n">solver_config</span> <span class="o">=</span> <span class="n">solver_parser_helper</span><span class="p">(</span>
                                    <span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">batchsize</span> <span class="o">=</span> <span class="n">batchsize</span><span class="p">,</span>                   <span class="c1"># Minibatch size for training</span>
                                    <span class="n">batchsize_eval</span> <span class="o">=</span> <span class="n">batchsize_eval</span><span class="p">,</span>         <span class="c1"># Minibatch size for eval </span>
                                    <span class="n">max_eval_batches</span> <span class="o">=</span> <span class="n">max_eval_batches</span><span class="p">,</span>     <span class="c1"># Max no. of eval batches on which eval will be done</span>
                                    <span class="n">model_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>                         <span class="c1"># Load any pretrained model , if training from scratch, leave empty</span>
                                    <span class="n">embedding_files</span> <span class="o">=</span> <span class="p">[],</span>                    <span class="c1"># Path to trained embedding table, if training from scratch then leave empty</span>
                                    <span class="n">vvgpu</span> <span class="o">=</span> <span class="p">[</span><span class="n">NUM_GPUS</span><span class="p">],</span>                      <span class="c1"># GPU Indices to be used ofr training</span>
                                    <span class="n">use_mixed_precision</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>             <span class="c1"># Flag to indicate use of Mixed precision training </span>
                                    <span class="n">scaler</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>                           <span class="c1"># To be set when MixedPrecisiontraining is ON</span>
                                    <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>                    <span class="c1"># As we are using Parquet from NVTabular, I64 should be true </span>
                                    <span class="n">use_algorithm_search</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>            <span class="c1"># Enable algo search within the fully connected-layers</span>
                                    <span class="n">use_cuda_graph</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>                  <span class="c1"># Enable cuda graph for forward and back proppogation</span>
                                    <span class="n">repeat_dataset</span> <span class="o">=</span> <span class="kc">True</span>                    <span class="c1"># Repeat the dataset for training, True for Non Epoch Based Training</span>
                                    <span class="p">)</span>

<span class="n">lr_sch</span> <span class="o">=</span> <span class="n">get_learning_rate_scheduler</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>                    <span class="c1"># Get learning rate statistics from optimizers     </span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">solver_config</span><span class="p">,</span> <span class="n">json_file</span><span class="p">)</span>                           <span class="c1"># Initialise a Session Object</span>
<span class="n">sess</span><span class="o">.</span><span class="n">start_data_reading</span><span class="p">()</span>                                          <span class="c1"># Start Data Reading</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>                                          <span class="c1"># Start training loop</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">lr_sch</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>                                         <span class="c1"># Update learning rate parameters                                   </span>
    <span class="n">sess</span><span class="o">.</span><span class="n">set_learning_rate</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>                                     <span class="c1"># Pass the updated learning rate to the session</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>                                                   <span class="c1"># Train on 1 iteration on 1 Minibatch</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="k">1000</span> == 0):
        <span class="n">loss</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get_current_loss</span><span class="p">()</span>                             <span class="c1"># Returns the loss value for the current iteration.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[HUGECTR][INFO] iter: </span><span class="si">{}</span><span class="s2">; loss: </span><span class="si">{:.6f}</span><span class="s2">; lr: </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="k">eval_trigger</span> == 0 and i != 0):
        <span class="n">sess</span><span class="o">.</span><span class="n">check_overflow</span><span class="p">()</span>                                      <span class="c1"># Checks whether any embedding has encountered overflow</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">copy_weights_for_evaluation</span><span class="p">()</span>                         <span class="c1"># Copies the weights of the dense network from training layers to evaluation layers.</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">solver_config</span><span class="o">.</span><span class="n">max_eval_batches</span><span class="p">):</span>
            <span class="n">sess</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>                                            <span class="c1"># Calculates the evaluation metrics based on one minibatch of evaluation data</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get_eval_metrics</span><span class="p">()</span>                          <span class="c1"># Returns the average evaluation metrics of several minibatches of evaluation data.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[HUGECTR][INFO] iter: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">metrics</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="k">snapshot_trigger</span> == 0 and i != 0):
        <span class="n">sess</span><span class="o">.</span><span class="n">download_params_to_files</span><span class="p">(</span><span class="n">weights_output_path</span> <span class="p">,</span> <span class="n">i</span><span class="p">)</span>     <span class="c1"># Saving model</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="train-config-json-for-count-and-target-encoded-features-dataset">
<h3>Train config json for count and target encoded features dataset<a class="headerlink" href="#train-config-json-for-count-and-target-encoded-features-dataset" title="Permalink to this headline"></a></h3>
<p>Following the same methodology as done above, we will modify the DLRM config file for this version of the dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define paths to save the config and the weights</span>

<span class="n">config_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_output_path</span><span class="p">,</span> <span class="s1">&#39;dlrm_fp32_count-target-encode_1gpu.json&#39;</span><span class="p">)</span>
<span class="n">weights_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">weights_path</span><span class="p">,</span><span class="s1">&#39;dlrm_fp32_count-target-encode_1gpu/&#39;</span><span class="p">)</span>

<span class="c1"># Creating Directory inside weights folder</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">weights_output_path</span><span class="p">):</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">weights_output_path</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">weights_output_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Path to the simple time based feature processed dataset</span>
<span class="n">output_train_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;processed_ce-te/train&quot;</span><span class="p">)</span>
<span class="n">output_valid_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;processed_ce-te/valid&quot;</span><span class="p">)</span>

<span class="c1"># Model related parameter</span>
<span class="n">embedding_vec_size</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optimizer</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Adam&quot;</span><span class="p">,</span>
        <span class="s2">&quot;update_type&quot;</span><span class="p">:</span> <span class="s2">&quot;Local&quot;</span><span class="p">,</span>
        <span class="s2">&quot;adam_hparam&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>
            <span class="s2">&quot;beta1&quot;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
            <span class="s2">&quot;beta2&quot;</span><span class="p">:</span> <span class="mf">0.999</span><span class="p">,</span>
            <span class="s2">&quot;epsilon&quot;</span><span class="p">:</span> <span class="mf">1e-07</span><span class="p">,</span>
            <span class="s2">&quot;warmup_steps&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
            <span class="s2">&quot;decay_start&quot;</span><span class="p">:</span> <span class="mi">20000</span><span class="p">,</span>
            <span class="s2">&quot;decay_steps&quot;</span><span class="p">:</span> <span class="mi">200000</span><span class="p">,</span>
            <span class="s2">&quot;decay_power&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;end_lr&quot;</span><span class="p">:</span> <span class="mf">1e-06</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;Parquet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;slot_size_array&quot;</span><span class="p">:</span> <span class="n">embedding_size_str_count_encode</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">output_train_path</span><span class="o">+</span><span class="s2">&quot;/_file_list.txt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eval_source&quot;</span><span class="p">:</span> <span class="n">output_valid_path</span><span class="o">+</span><span class="s2">&quot;/_file_list.txt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label_dim&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="s2">&quot;dense&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dense_dim&quot;</span><span class="p">:</span> <span class="mi">9</span>
            <span class="p">},</span>
            <span class="s2">&quot;sparse&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;data1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LocalizedSlot&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;max_feature_num_per_sample&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings_count_encode</span><span class="p">),</span>
                    <span class="s2">&quot;max_nnz&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;slot_num&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">embeddings_count_encode</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LocalizedSlotSparseEmbeddingHash&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;data1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sparse_embedding_hparam&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;slot_size_array&quot;</span><span class="p">:</span> <span class="n">embedding_size_str_count_encode</span><span class="p">,</span>
                <span class="s2">&quot;embedding_vec_size&quot;</span><span class="p">:</span> <span class="n">embedding_vec_size</span><span class="p">,</span>
                <span class="s2">&quot;combiner&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">512</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">256</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="n">embedding_vec_size</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu3&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Interaction&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;relu3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sparse_embedding1&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1024</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1024</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">512</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">256</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;loss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;BinaryCrossEntropyLoss&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;fc8&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;loss&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;optimizer&quot;</span><span class="p">:</span> <span class="n">optimizer</span><span class="p">,</span>
    <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="n">layers</span>
<span class="p">}</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solver related parameters</span>
<span class="n">NUM_GPUS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>                                               <span class="c1"># GPUs used for training</span>
<span class="n">json_file</span> <span class="o">=</span> <span class="n">config_file_path</span>                                       <span class="c1"># Path to the json config file</span>
<span class="n">batchsize</span> <span class="o">=</span> <span class="mi">2048</span>                                                   <span class="c1"># Batch size used for training</span>
<span class="n">batchsize_eval</span> <span class="o">=</span> <span class="mi">2048</span>                                              <span class="c1"># Batch size used during evaluation</span>
<span class="n">max_eval_batches</span> <span class="o">=</span> <span class="mi">3768</span>                                            <span class="c1"># Iterations required to go through the complete validation set with the set batchsize_eval</span>

<span class="c1"># Training related parameters</span>
<span class="n">num_iter</span> <span class="o">=</span> <span class="mi">30001</span>                                                   <span class="c1"># Iterations to train the model for</span>
<span class="n">eval_trigger</span> <span class="o">=</span> <span class="mi">10000</span>                                               <span class="c1"># Start evaluation after these iterations</span>
<span class="n">snapshot_trigger</span> <span class="o">=</span> <span class="mi">10000</span>                                           <span class="c1"># Save model checkpoints after these iterations</span>

<span class="n">solver_config</span> <span class="o">=</span> <span class="n">solver_parser_helper</span><span class="p">(</span>
                                    <span class="n">seed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="n">batchsize</span> <span class="o">=</span> <span class="n">batchsize</span><span class="p">,</span>                       <span class="c1"># Minibatch size for training</span>
                                    <span class="n">batchsize_eval</span> <span class="o">=</span> <span class="n">batchsize_eval</span><span class="p">,</span>         <span class="c1"># Minibatch size for eval </span>
                                    <span class="n">max_eval_batches</span> <span class="o">=</span> <span class="n">max_eval_batches</span><span class="p">,</span>     <span class="c1"># Max no. of eval batches on which eval will be done</span>
                                    <span class="n">model_file</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>                         <span class="c1"># Load any pretrained model , if training from scratch, leave empty</span>
                                    <span class="n">embedding_files</span> <span class="o">=</span> <span class="p">[],</span>                    <span class="c1"># Path to trained embedding table, if training from scratch then leave empty</span>
                                    <span class="n">vvgpu</span> <span class="o">=</span> <span class="p">[</span><span class="n">NUM_GPUS</span><span class="p">],</span>                      <span class="c1"># GPU Indices to be used ofr training</span>
                                    <span class="n">use_mixed_precision</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>             <span class="c1"># Flag to indicate use of Mixed precision training </span>
                                    <span class="n">scaler</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>                           <span class="c1"># To be set when MixedPrecisiontraining is ON</span>
                                    <span class="n">i64_input_key</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>                    <span class="c1"># As we are using Parquet from NVTabular, I64 should be true </span>
                                    <span class="n">use_algorithm_search</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>            <span class="c1"># Enable algo search within the fully connected-layers</span>
                                    <span class="n">use_cuda_graph</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>                  <span class="c1"># Enable cuda graph for forward and back proppogation</span>
                                    <span class="n">repeat_dataset</span> <span class="o">=</span> <span class="kc">True</span>                    <span class="c1"># Repeat the dataset for training, True for Non Epoch Based Training</span>
                                    <span class="p">)</span>

<span class="n">lr_sch</span> <span class="o">=</span> <span class="n">get_learning_rate_scheduler</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>                    <span class="c1"># Get learning rate statistics from optimizers     </span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">solver_config</span><span class="p">,</span> <span class="n">json_file</span><span class="p">)</span>                           <span class="c1"># Initialise a Session Object</span>
<span class="n">sess</span><span class="o">.</span><span class="n">start_data_reading</span><span class="p">()</span>                                          <span class="c1"># Start Data Reading</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>                                          <span class="c1"># Start training loop</span>
    <span class="n">lr</span> <span class="o">=</span> <span class="n">lr_sch</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>                                         <span class="c1"># Update learning rate parameters                                   </span>
    <span class="n">sess</span><span class="o">.</span><span class="n">set_learning_rate</span><span class="p">(</span><span class="n">lr</span><span class="p">)</span>                                     <span class="c1"># Pass the updated learning rate to the session</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>                                                   <span class="c1"># Train on 1 iteration on 1 Minibatch</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="k">1000</span> == 0):
        <span class="n">loss</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get_current_loss</span><span class="p">()</span>                             <span class="c1"># Returns the loss value for the current iteration.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[HUGECTR][INFO] iter: </span><span class="si">{}</span><span class="s2">; loss: </span><span class="si">{:.6f}</span><span class="s2">; lr: </span><span class="si">{:.6f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">lr</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="k">eval_trigger</span> == 0 and i != 0):
        <span class="n">sess</span><span class="o">.</span><span class="n">check_overflow</span><span class="p">()</span>                                      <span class="c1"># Checks whether any embedding has encountered overflow</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">copy_weights_for_evaluation</span><span class="p">()</span>                         <span class="c1"># Copies the weights of the dense network from training layers to evaluation layers.</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">solver_config</span><span class="o">.</span><span class="n">max_eval_batches</span><span class="p">):</span>
            <span class="n">sess</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>                                            <span class="c1"># Calculates the evaluation metrics based on one minibatch of evaluation data</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">get_eval_metrics</span><span class="p">()</span>                          <span class="c1"># Returns the average evaluation metrics of several minibatches of evaluation data.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[HUGECTR][INFO] iter: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">metrics</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="k">snapshot_trigger</span> == 0 and i != 0):
        <span class="n">sess</span><span class="o">.</span><span class="n">download_params_to_files</span><span class="p">(</span><span class="n">weights_output_path</span> <span class="p">,</span> <span class="n">i</span><span class="p">)</span>     <span class="c1"># Saving model</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="step-8-inference-on-1st-validation-set-with-hugectr">
<h2>Step 8: Inference on 1st validation set with HugeCTR<a class="headerlink" href="#step-8-inference-on-1st-validation-set-with-hugectr" title="Permalink to this headline"></a></h2>
<p>After training 2 DLRM models, let’s evaluate them on the validation set using HugeCTR’s python inference API. The evaluation metric is AUC.<br>
We will first write the inference config file, then prepare the validation data into CSR format and finally use the inference APIs to get the predictions.</p>
<p>Let’s start with the first trained model i.e. DLRM trained on simple time based features. In the next step, we would repeat the same process for the second trained model.</p>
<div class="section" id="infer-config-json">
<h3>Infer config json<a class="headerlink" href="#infer-config-json" title="Permalink to this headline"></a></h3>
<p>We need to first prepare a inference json file. The important modifications required in the train config file are:</p>
<ul class="simple">
<li><p>Omit the <code class="docutils literal notranslate"><span class="pre">optimizer</span></code> and <code class="docutils literal notranslate"><span class="pre">solver</span></code> clauses, while adding and <code class="docutils literal notranslate"><span class="pre">inference</span></code> clause</p></li>
<li><p>Change the output layer to <code class="docutils literal notranslate"><span class="pre">Sigmoid</span></code> type.</p></li>
</ul>
<p>Let’s first write the infer config file for the simple time based feature dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="n">config_inference_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_output_path</span><span class="p">,</span><span class="s1">&#39;dlrm_fp32_simple-time_1gpu_inference.json&#39;</span><span class="p">)</span>
<span class="n">weights_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">weights_path</span><span class="p">,</span><span class="s1">&#39;dlrm_fp32_simple-time_1gpu/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adding the path to the dense and sparse model checkpoints from the weights directory</span>
<span class="n">inference</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_batchsize&quot;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
    <span class="s2">&quot;dense_model_file&quot;</span><span class="p">:</span> <span class="n">weights_output_path</span><span class="o">+</span><span class="s2">&quot;/_dense_30000.model&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sparse_model_file&quot;</span><span class="p">:</span> <span class="n">weights_output_path</span><span class="o">+</span><span class="s2">&quot;/0_sparse_30000.model&quot;</span><span class="p">,</span>
    <span class="s2">&quot;input_key_type&quot;</span><span class="p">:</span> <span class="s2">&quot;I64&quot;</span>
  <span class="p">}</span>

<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label_dim&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="s2">&quot;dense&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dense_dim&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="s2">&quot;sparse&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;data1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LocalizedSlot&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;max_feature_num_per_sample&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">embedding_size_str_simple_time</span><span class="p">),</span>
                    <span class="s2">&quot;max_nnz&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;slot_num&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">embedding_size_str_simple_time</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LocalizedSlotSparseEmbeddingHash&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;data1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sparse_embedding_hparam&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;slot_size_array&quot;</span><span class="p">:</span> <span class="n">embedding_size_str_simple_time</span><span class="p">,</span>
                <span class="s2">&quot;embedding_vec_size&quot;</span><span class="p">:</span> <span class="n">embedding_vec_size</span><span class="p">,</span>
                <span class="s2">&quot;combiner&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">512</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">256</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="n">embedding_vec_size</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu3&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Interaction&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;relu3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sparse_embedding1&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1024</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1024</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">512</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">256</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">},</span>

      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Sigmoid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;fc8&quot;</span><span class="p">],</span>
        <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;sigmoid&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;inference&quot;</span><span class="p">:</span> <span class="n">inference</span><span class="p">,</span>
    <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="n">layers</span>
<span class="p">}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_inference_file_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="prepare-validation-set-for-inference">
<h3>Prepare validation set for inference<a class="headerlink" href="#prepare-validation-set-for-inference" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">output_valid_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;processed_nvt/valid&quot;</span><span class="p">)</span>

<span class="n">nvtdata_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">output_valid_path</span><span class="p">)</span>
<span class="n">nvtdata_test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">con_feats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hist_count&#39;</span><span class="p">]</span>

<span class="n">cat_feats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time_hour&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_1&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_1&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_3&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_3&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_4&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_4&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_5&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_5&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_6&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_6&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_7&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_7&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_8&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_8&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_9&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_9&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impr_cat&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impr_subcat&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impression_id&#39;</span><span class="p">,</span>
 <span class="s1">&#39;uid&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_minute&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_second&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_wd&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_day&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_day_week&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>For inference, HugeCTR expects the data to conform to CSR format which mandates the categorical variables to occupy different integer ranges.<br>
As an example, if there are 10 users and 10 items then HugeCTR expects the users to be encoded in the 1-10 range, while the items to be encoded in the 11-20 range. NVTabular encodes both users and items in the 1-10 ranges.</p>
<p>For this reason, we need to shift the keys of the categorical variable produced by NVTabular to comply with HugeCTR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">embedding_size_str_simple_time</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">cat_data</span> <span class="o">=</span> <span class="n">nvtdata_test</span><span class="p">[</span><span class="n">cat_feats</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">shift</span>
<span class="n">dense_data</span> <span class="o">=</span> <span class="n">nvtdata_test</span><span class="p">[</span><span class="n">con_feats</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="create-inference-session">
<h3>Create inference session<a class="headerlink" href="#create-inference-session" title="Permalink to this headline"></a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">hugectr.inference</span> <span class="kn">import</span> <span class="n">CreateParameterServer</span><span class="p">,</span> <span class="n">CreateEmbeddingCache</span><span class="p">,</span> <span class="n">InferenceSession</span>

<span class="c1"># Declare parameter server, embedding cache and inference session using inference config</span>
<span class="n">parameter_server</span> <span class="o">=</span> <span class="n">CreateParameterServer</span><span class="p">([</span><span class="n">config_inference_file_path</span><span class="p">],[</span><span class="s2">&quot;DLRM&quot;</span><span class="p">],</span><span class="kc">True</span><span class="p">)</span>
<span class="n">embedding_cache</span> <span class="o">=</span> <span class="n">CreateEmbeddingCache</span><span class="p">(</span><span class="n">parameter_server</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="n">config_inference_file_path</span><span class="p">,</span><span class="s2">&quot;DLRM&quot;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
<span class="n">inference_session</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">config_inference_file_path</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">embedding_cache</span><span class="p">)</span>

<span class="c1"># Define a function to perform batched inference</span>
<span class="k">def</span> <span class="nf">infer_batch</span><span class="p">(</span><span class="n">inference_session</span><span class="p">,</span> <span class="n">dense_data_batch</span><span class="p">,</span> <span class="n">cat_data_batch</span><span class="p">):</span>
    <span class="n">dense_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dense_data_batch</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">embedding_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cat_data_batch</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="n">row_ptrs</span><span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">embedding_columns</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="n">output</span> <span class="o">=</span> <span class="n">inference_session</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dense_features</span><span class="p">,</span> <span class="n">embedding_columns</span><span class="p">,</span> <span class="n">row_ptrs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
</div>
</div>
<p>Now we are ready to carry out inference.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2048</span>
<span class="n">num_batches</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dense_data</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">batch_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dense_data</span><span class="p">)),</span> <span class="n">num_batches</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">batch_id</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">dense_data_batch</span> <span class="o">=</span> <span class="n">dense_data</span><span class="p">[</span><span class="n">batch_id</span><span class="p">]</span>
    <span class="n">cat_data_batch</span> <span class="o">=</span> <span class="n">cat_data</span><span class="p">[</span><span class="n">batch_id</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">infer_batch</span><span class="p">(</span><span class="n">inference_session</span><span class="p">,</span> <span class="n">dense_data_batch</span><span class="p">,</span> <span class="n">cat_data_batch</span><span class="p">)</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract ground truth to calculate AUC</span>
<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">nvtdata_test</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>

<span class="n">roc_auc_score</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="step-9-inference-on-2nd-validation-set-with-hugectr">
<h2>Step 9: Inference on 2nd validation set with HugeCTR<a class="headerlink" href="#step-9-inference-on-2nd-validation-set-with-hugectr" title="Permalink to this headline"></a></h2>
<p>Following the same procedure as in the last step, let’s compute the AUC on the count plus target encoded feature engineered validation set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config_inference_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config_output_path</span><span class="p">,</span> <span class="s1">&#39;dlrm_fp32_count-target-encode_1gpu_inference.json&#39;</span><span class="p">)</span>
<span class="n">weights_output_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">weights_path</span><span class="p">,</span><span class="s1">&#39;dlrm_fp32_count-target-encode_1gpu/&#39;</span><span class="p">)</span>

<span class="n">inference</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_batchsize&quot;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
    <span class="s2">&quot;dense_model_file&quot;</span><span class="p">:</span> <span class="n">weights_output_path</span><span class="o">+</span><span class="s2">&quot;/_dense_30000.model&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sparse_model_file&quot;</span><span class="p">:</span> <span class="n">weights_output_path</span><span class="o">+</span><span class="s2">&quot;/0_sparse_30000.model&quot;</span><span class="p">,</span>
    <span class="s2">&quot;input_key_type&quot;</span><span class="p">:</span> <span class="s2">&quot;I64&quot;</span>
  <span class="p">}</span>

<span class="n">layers</span> <span class="o">=</span> <span class="p">[</span>
      <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;check&quot;</span><span class="p">:</span> <span class="s2">&quot;None&quot;</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label_dim&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">},</span>
            <span class="s2">&quot;dense&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dense_dim&quot;</span><span class="p">:</span> <span class="mi">9</span>
            <span class="p">},</span>
            <span class="s2">&quot;sparse&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;data1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LocalizedSlot&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;max_feature_num_per_sample&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">embedding_size_str_count_encode</span><span class="p">),</span>
                    <span class="s2">&quot;max_nnz&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s2">&quot;slot_num&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">embedding_size_str_count_encode</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;LocalizedSlotSparseEmbeddingHash&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;data1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;sparse_embedding1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sparse_embedding_hparam&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;slot_size_array&quot;</span><span class="p">:</span> <span class="n">embedding_size_str_count_encode</span><span class="p">,</span>
                <span class="s2">&quot;embedding_vec_size&quot;</span><span class="p">:</span> <span class="n">embedding_vec_size</span><span class="p">,</span>
                <span class="s2">&quot;combiner&quot;</span><span class="p">:</span> <span class="mi">0</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;dense&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">512</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">256</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="n">embedding_vec_size</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc3&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu3&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Interaction&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;relu3&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sparse_embedding1&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;interaction1&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1024</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu4&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1024</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu5&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">512</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">256</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ReLU&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;fc7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;fc8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;InnerProduct&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="s2">&quot;relu7&quot;</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;fc8&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fc_param&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;num_output&quot;</span><span class="p">:</span> <span class="mi">1</span>
            <span class="p">}</span>
        <span class="p">},</span>

      <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sigmoid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Sigmoid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;fc8&quot;</span><span class="p">],</span>
        <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;sigmoid&quot;</span>
      <span class="p">}</span>
    <span class="p">]</span>


<span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;inference&quot;</span><span class="p">:</span> <span class="n">inference</span><span class="p">,</span>
    <span class="s2">&quot;layers&quot;</span><span class="p">:</span> <span class="n">layers</span>
<span class="p">}</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_inference_file_path</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_valid_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;processed_ce-te/valid&quot;</span><span class="p">)</span>

<span class="n">nvtdata_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">output_valid_path</span><span class="p">)</span>
<span class="n">nvtdata_test</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">con_feats</span> <span class="o">=</span> <span class="p">[</span>
 <span class="s1">&#39;TE_hist_cat_0_hist_cat_1_hist_cat_2_hist_cat_3_hist_cat_4_impr_cat_label_TE&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TE_hist_cat_1_hist_cat_2_hist_cat_3_hist_cat_4_hist_cat_5_impr_cat_label_TE&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TE_hist_cat_2_hist_cat_3_hist_cat_4_hist_cat_5_hist_cat_6_impr_cat_label_TE&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TE_hist_cat_3_hist_cat_4_hist_cat_5_hist_cat_6_hist_cat_7_impr_cat_label_TE&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TE_hist_cat_4_hist_cat_5_hist_cat_6_hist_cat_7_hist_cat_8_impr_cat_label_TE&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TE_hist_cat_5_hist_cat_6_hist_cat_7_hist_cat_8_hist_cat_9_impr_cat_label_TE&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_count&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impr_cat_count&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impr_subcat_count&#39;</span><span class="p">]</span>

<span class="n">cat_feats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_1&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_1&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_3&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_3&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_4&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_4&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_5&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_5&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_6&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_6&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_7&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_7&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_8&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_8&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_cat_9&#39;</span><span class="p">,</span>
 <span class="s1">&#39;hist_subcat_9&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impr_cat&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impr_subcat&#39;</span><span class="p">,</span>
 <span class="s1">&#39;impression_id&#39;</span><span class="p">,</span>
 <span class="s1">&#39;uid&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_hour&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_minute&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_second&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_wd&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_day&#39;</span><span class="p">,</span>
 <span class="s1">&#39;time_day_week&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">embedding_size_str_count_encode</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">cat_data</span> <span class="o">=</span> <span class="n">nvtdata_test</span><span class="p">[</span><span class="n">cat_feats</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">shift</span>

<span class="n">dense_data</span> <span class="o">=</span> <span class="n">nvtdata_test</span><span class="p">[</span><span class="n">con_feats</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create parameter server, embedding cache and inference session</span>
<span class="n">parameter_server</span> <span class="o">=</span> <span class="n">CreateParameterServer</span><span class="p">([</span><span class="n">config_inference_file_path</span><span class="p">],[</span><span class="s2">&quot;DLRM&quot;</span><span class="p">],</span><span class="kc">True</span><span class="p">)</span>
<span class="n">embedding_cache</span> <span class="o">=</span> <span class="n">CreateEmbeddingCache</span><span class="p">(</span><span class="n">parameter_server</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="n">config_inference_file_path</span><span class="p">,</span><span class="s2">&quot;DLRM&quot;</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
<span class="n">inference_session</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">config_inference_file_path</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">embedding_cache</span><span class="p">)</span>

<span class="c1"># Define a function to perform batched inference</span>

<span class="k">def</span> <span class="nf">infer_batch</span><span class="p">(</span><span class="n">inference_session</span><span class="p">,</span> <span class="n">dense_data_batch</span><span class="p">,</span> <span class="n">cat_data_batch</span><span class="p">):</span>
    <span class="n">dense_features</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dense_data_batch</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">embedding_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cat_data_batch</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="n">row_ptrs</span><span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">embedding_columns</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="n">output</span> <span class="o">=</span> <span class="n">inference_session</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">dense_features</span><span class="p">,</span> <span class="n">embedding_columns</span><span class="p">,</span> <span class="n">row_ptrs</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span>
</pre></div>
</div>
</div>
</div>
<p>Now we are ready to carry out inference on the test set.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2048</span>
<span class="n">num_batches</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dense_data</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">batch_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dense_data</span><span class="p">)),</span> <span class="n">num_batches</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">batch_id</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">batch_idx</span><span class="p">):</span>
    <span class="n">dense_data_batch</span> <span class="o">=</span> <span class="n">dense_data</span><span class="p">[</span><span class="n">batch_id</span><span class="p">]</span>
    <span class="n">cat_data_batch</span> <span class="o">=</span> <span class="n">cat_data</span><span class="p">[</span><span class="n">batch_id</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">infer_batch</span><span class="p">(</span><span class="n">inference_session</span><span class="p">,</span> <span class="n">dense_data_batch</span><span class="p">,</span> <span class="n">cat_data_batch</span><span class="p">)</span>
    <span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract ground truth to calculate AUC</span>

<span class="n">ground_truth</span> <span class="o">=</span> <span class="n">nvtdata_test</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline"></a></h2>
<p>In this tutorial notebook, we have walked through the process of data cleaning, pre-processing, feature engineering to model training and inferencing, all using the Merlin framework. We hope that this notebook would be helpful for building Recommendation Systems on your datasets as well.</p>
<p>Feel free to experiment with the various hyper-parameters on the feature engineering and model training side and share your results!</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="hugectr_wdl_prediction.html" class="btn btn-neutral float-left" title="HugeCTR Wide and Deep Model with Criteo" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="multi_gpu_offline_inference.html" class="btn btn-neutral float-right" title="Multi-GPU Offline Inference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, NVIDIA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: v3.9.1
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Tags</dt>
      <dd><a href="../../v3.8/index.html">v3.8</a></dd>
      <dd><a href="../../v3.9/index.html">v3.9</a></dd>
      <dd><a href="news-example.html">v3.9.1</a></dd>
      <dd><a href="../../v4.0/index.html">v4.0</a></dd>
      <dd><a href="../../v4.1/index.html">v4.1</a></dd>
      <dd><a href="../../v4.1.1/index.html">v4.1.1</a></dd>
    </dl>
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../main/index.html">main</a></dd>
    </dl>
  </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NVJ1Y1YJHK"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-NVJ1Y1YJHK', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>